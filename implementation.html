<!DOCTYPE html>
<html xmlns='http://www.w3.org/1999/xhtml' xml:lang='en' lang='en'>
<head>
<title>Implementation details (not part of API)</title>
<link type='text/css' href='style.css' rel='stylesheet'>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="viewport" content="width=device-width">
<script src="jquery.min.js"></script>
<script src="toc.min.js"></script>
<script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML"></script>
   
</head>
<body>
<div id="content-container">
<div id="toc">
<div id="page-toc">
</div>
<div id="toc-footer"><ul><li><a href="https://github.com/melisgl/mgl-pax">[generated by MGL-PAX]</a></li></ul></div>
</div>
<div id="content">
<p><a id="x-28HTTP2-3A-40IMPLEMENTATION-20MGL-PAX-3ASECTION-29"></a>
<a id="HTTP2:@IMPLEMENTATION%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="reference.html#HTTP2%2FSERVER:@LOGGING%20MGL-PAX:SECTION" title="Logging support">&#8592;</a> <a href="index.html" title="`HTTP2` in Common Lisp">&#8593;</a> <a href="#HTTP2%2FCORE:@IMPLEMENTATION%2FOVERVIEW%20MGL-PAX:SECTION" title="Overview">&#8594;</a> <a href="implementation.html" title="Implementation details (not part of API)">&#8634;</a> <a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/overview.lisp#L48">&#955;</a></span></span></p>

<h2><a href="implementation.html">4 Implementation details (not part of API)</a></h2>

<p>Here are some notes that try to explain how are things implemented. If this is
out of sync or if it does not make sense at all, fixing it is not a hight
priority, and definitely not a blocker.</p>

<p><a id="x-28HTTP2-2FCORE-3A-40IMPLEMENTATION-2FOVERVIEW-20MGL-PAX-3ASECTION-29"></a>
<a id="HTTP2%2FCORE:@IMPLEMENTATION%2FOVERVIEW%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="implementation.html" title="Implementation details (not part of API)">&#8592;</a> <a href="implementation.html" title="Implementation details (not part of API)">&#8593;</a> <a href="#HTTP2%2FCORE:@CONNECTIONS%20MGL-PAX:SECTION" title="HTTP/2 Connections">&#8594;</a> <a href="#HTTP2%2FCORE:@IMPLEMENTATION%2FOVERVIEW%20MGL-PAX:SECTION" title="Overview">&#8634;</a> <a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/core/classes.lisp#L5">&#955;</a></span></span></p>

<h3><a href="#HTTP2%2FCORE:@IMPLEMENTATION%2FOVERVIEW%20MGL-PAX:SECTION">4.1 Overview</a></h3>

<h6>[in package HTTP2/CORE]</h6>

<p>There are three core groups of classes:</p>

<ul>
<li><p><a href="#HTTP2%2FCORE:@CONNECTIONS%20MGL-PAX:SECTION" title="HTTP/2 Connections">HTTP/2 Connections</a>, derived from <a href="#HTTP2%2FCORE:HTTP2-CONNECTION%20CLASS" title="HTTP2/CORE:HTTP2-CONNECTION CLASS"><code>HTTP2-CONNECTION</code></a>, represent a connection as in the RFC,</p></li>
<li><p>Streams, derived from <a href="#HTTP2%2FCORE:HTTP2-STREAM-MINIMAL%20CLASS" title="HTTP2/CORE:HTTP2-STREAM-MINIMAL CLASS"><code>HTTP2-STREAM-MINIMAL</code></a>, represent a HTTP/2 stream as in the RFC,</p></li>
<li><p>Dispatchers, derived from HTTP2/server/shared:BASE-DISPATCHER, represent a server that may receive and dispatch new connections.</p></li>
</ul>

<p>Dispatcher create new connection instances as they receive requests, and
connections create new stream instances to serve the streams to the clients.</p>

<p>Clients do not need dispatchers; they create the connection to the server explicitly.</p>

<p><a id="x-28HTTP2-2FCORE-3ARECEIVER-FN-20TYPE-29"></a>
<a id="HTTP2%2FCORE:RECEIVER-FN%20TYPE"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/core/frames.lisp#L161">[type]</a></span> <span class="reference-object"><a href="#HTTP2%2FCORE:RECEIVER-FN%20TYPE" >RECEIVER-FN</a></span></span></span></p>

<p>Function that reads and processes number of octets, and returns next function and its needed size.</p></li>
</ul>

<p><a id="x-28HTTP2-2FCORE-3A-40CONNECTIONS-20MGL-PAX-3ASECTION-29"></a>
<a id="HTTP2%2FCORE:@CONNECTIONS%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#HTTP2%2FCORE:@IMPLEMENTATION%2FOVERVIEW%20MGL-PAX:SECTION" title="Overview">&#8592;</a> <a href="#HTTP2%2FCORE:@IMPLEMENTATION%2FOVERVIEW%20MGL-PAX:SECTION" title="Overview">&#8593;</a> <a href="#HTTP2%2FCORE:@DATA%20MGL-PAX:SECTION" title="Data and flow control">&#8594;</a> <a href="#HTTP2%2FCORE:@CONNECTIONS%20MGL-PAX:SECTION" title="HTTP/2 Connections">&#8634;</a> <a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/core/classes.lisp#L24">&#955;</a></span></span></p>

<h4><a href="#HTTP2%2FCORE:@CONNECTIONS%20MGL-PAX:SECTION">4.1.1 HTTP/2 Connections</a></h4>

<p><a id="x-28HTTP2-2FCORE-3AHTTP2-CONNECTION-20CLASS-29"></a>
<a id="HTTP2%2FCORE:HTTP2-CONNECTION%20CLASS"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/core/classes.lisp#L40">[class]</a></span> <span class="reference-object"><a href="#HTTP2%2FCORE:HTTP2-CONNECTION%20CLASS" >HTTP2-CONNECTION</a></span></span> <span class="locative-args">FRAME-CONTEXT <a href="#HTTP2%2FCORE:STREAM-COLLECTION%20CLASS" title="HTTP2/CORE:STREAM-COLLECTION CLASS">STREAM-COLLECTION</a> FLOW-CONTROL-MIXIN</span></span></p>

<p>A simple connection instance reflecting several aspects of the connections:</p>

<ul>
<li><p>connection is a collection of streams  (<a href="#HTTP2%2FCORE:STREAM-COLLECTION%20CLASS" title="HTTP2/CORE:STREAM-COLLECTION CLASS"><code>STREAM-COLLECTION</code></a>),</p></li>
<li><p>connection maintains flow control (<code>FLOW-CONTROL-MIXIN</code>),</p></li>
<li><p>connection maintains hpack state (<code>HPACK-ENDPOINT</code>),</p></li>
<li><p>connection maintain some  internal configuration variables such as maximum frames size (<code>FRAME-CONTEXT</code>),</p></li>
<li><p>connection maintain window sizes (<code>FLOW-CONTROL-MIXIN</code>),</p></li>
<li><p>connection can create new streams and needs to track the parameters of the new stream (class, windows sizes)</p></li>
</ul></li>
</ul>

<p>At any point of time, a <a href="#HTTP2%2FCORE:HTTP2-CONNECTION%20CLASS" title="HTTP2/CORE:HTTP2-CONNECTION CLASS"><code>HTTP2-CONNECTION</code></a> expects explicit number of octets as an
input, i.e., 9 octets for a header, or frame size octets of the frame
payload. This information is not stored in the connection (why?), but lexically
in a loop in functions that make the update, together with a function that acts
on the connection when the data are available. See
<code>HTTP2/STREAM-OVERLAY:PROCESS-PENDING-FRAMES</code> that reads the input data
from (Common Lisp) binary <a href="http://www.lispworks.com/documentation/HyperSpec/Body/t_stream.htm" title="STREAM (MGL-PAX:CLHS CLASS)"><code>STREAM</code></a> as one example. See <a href="#HTTP2%2FCORE:@DATA-RECEIVED%20MGL-PAX:SECTION" title="Processing data frames">Processing data frames</a>.</p>

<p><a id="x-28HTTP2-2FCORE-3ASERVER-HTTP2-CONNECTION-20CLASS-29"></a>
<a id="HTTP2%2FCORE:SERVER-HTTP2-CONNECTION%20CLASS"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/core/classes.lisp#L102">[class]</a></span> <span class="reference-object"><a href="#HTTP2%2FCORE:SERVER-HTTP2-CONNECTION%20CLASS" >SERVER-HTTP2-CONNECTION</a></span></span> <span class="locative-args"><a href="#HTTP2%2FCORE:HTTP2-CONNECTION%20CLASS" title="HTTP2/CORE:HTTP2-CONNECTION CLASS">HTTP2-CONNECTION</a></span></span></p>

<p>Server connection initiate even numbered streams.</p></li>
</ul>

<p><a id="x-28HTTP2-2FCORE-3ACLIENT-HTTP2-CONNECTION-20CLASS-29"></a>
<a id="HTTP2%2FCORE:CLIENT-HTTP2-CONNECTION%20CLASS"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/core/classes.lisp#L96">[class]</a></span> <span class="reference-object"><a href="#HTTP2%2FCORE:CLIENT-HTTP2-CONNECTION%20CLASS" >CLIENT-HTTP2-CONNECTION</a></span></span> <span class="locative-args"><a href="#HTTP2%2FCORE:HTTP2-CONNECTION%20CLASS" title="HTTP2/CORE:HTTP2-CONNECTION CLASS">HTTP2-CONNECTION</a></span></span></p>

<p>Client connections initiate odd-numbered streams.</p></li>
</ul>

<p><a id="x-28HTTP2-2FCORE-3AGET-PEER-NAME-20GENERIC-FUNCTION-29"></a>
<a id="HTTP2%2FCORE:GET-PEER-NAME%20GENERIC-FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/core/classes.lisp#L68">[generic-function]</a></span> <span class="reference-object"><a href="#HTTP2%2FCORE:GET-PEER-NAME%20GENERIC-FUNCTION" >GET-PEER-NAME</a></span></span> <span class="locative-args">OBJECT</span></span></p>

<p>Name of the peer. Used primarily in log messages and when object is printed.</p>

<p>Content can vary, e.g.,</p>

<ul>
<li><p>for a server connection peer IP and port,</p></li>
<li><p>for a client connection hostname of the peer.</p></li>
</ul>

<p>The fallback is unescaped print of the object.</p></li>
</ul>

<p><a id="x-28HTTP2-2FCORE-3AGET-INITIAL-PEER-WINDOW-SIZE-20GENERIC-FUNCTION-29"></a>
<a id="HTTP2%2FCORE:GET-INITIAL-PEER-WINDOW-SIZE%20GENERIC-FUNCTION"></a></p>

<ul>
<li><span class=reference-bullet><span class=reference><span class="locative-type">[generic-function]</span> <span class="reference-object"><a href="#HTTP2%2FCORE:GET-INITIAL-PEER-WINDOW-SIZE%20GENERIC-FUNCTION" >GET-INITIAL-PEER-WINDOW-SIZE</a></span></span> <span class="locative-args">OBJECT</span></span></li>
</ul>

<p><a id="x-28HTTP2-2FCORE-3A-40DATA-20MGL-PAX-3ASECTION-29"></a>
<a id="HTTP2%2FCORE:@DATA%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#HTTP2%2FCORE:@CONNECTIONS%20MGL-PAX:SECTION" title="HTTP/2 Connections">&#8592;</a> <a href="#HTTP2%2FCORE:@CONNECTIONS%20MGL-PAX:SECTION" title="HTTP/2 Connections">&#8593;</a> <a href="#HTTP2%2FCORE:@STREAMS%20MGL-PAX:SECTION" title="HTTP/2 Streams">&#8594;</a> <a href="#HTTP2%2FCORE:@DATA%20MGL-PAX:SECTION" title="Data and flow control">&#8634;</a> <a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/core/frames/data.lisp#L121">&#955;</a></span></span></p>

<h5><a href="#HTTP2%2FCORE:@DATA%20MGL-PAX:SECTION">Data and flow control</a></h5>

<p>HTTP streams can receive some data (content, body). We can see treat in
several ways:</p>

<ul>
<li><p>we can collect the data till all is received (end of stream from the peer) and
  then process it as whole. If you need this, use <a href="#HTTP2%2FCORE:BODY-COLLECTING-MIXIN%20CLASS" title="HTTP2/CORE:BODY-COLLECTING-MIXIN CLASS"><code>BODY-COLLECTING-MIXIN</code></a> class and <a href="#HTTP2%2FCORE:GET-BODY%20GENERIC-FUNCTION" title="HTTP2/CORE:GET-BODY GENERIC-FUNCTION"><code>GET-BODY</code></a> function, or
  <a href="#HTTP2%2FCORE:TEXT-COLLECTING-STREAM%20CLASS" title="HTTP2/CORE:TEXT-COLLECTING-STREAM CLASS"><code>TEXT-COLLECTING-STREAM</code></a> class and <a href="index.html#HTTP2%2FCORE:HTTP-STREAM-TO-STRING%20FUNCTION" title="HTTP2/CORE:HTTP-STREAM-TO-STRING FUNCTION"><code>HTTP-STREAM-TO-STRING</code></a> function.</p></li>
<li><p>we may want to do something with each recieved chunk of data as soon as it
  arrives. In this case, specialize <a href="#HTTP2%2FCORE:APPLY-DATA-FRAME%20GENERIC-FUNCTION" title="HTTP2/CORE:APPLY-DATA-FRAME GENERIC-FUNCTION"><code>APPLY-DATA-FRAME</code></a> or <a href="#HTTP2%2FCORE:APPLY-TEXT-DATA-FRAME%20GENERIC-FUNCTION" title="HTTP2/CORE:APPLY-TEXT-DATA-FRAME GENERIC-FUNCTION"><code>APPLY-TEXT-DATA-FRAME</code></a>.</p></li>
</ul>

<p>In both cases, one may want to work either with a string or with octets. The
latter is default, for the former use <a href="#HTTP2%2FCORE:UTF8-PARSER-MIXIN%20CLASS" title="HTTP2/CORE:UTF8-PARSER-MIXIN CLASS"><code>UTF8-PARSER-MIXIN</code></a> and/or
<a href="index.html#HTTP2%2FCORE:FALLBACK-ALL-IS-ASCII%20CLASS" title="HTTP2/CORE:FALLBACK-ALL-IS-ASCII CLASS"><code>FALLBACK-ALL-IS-ASCII</code></a>.</p>

<p>The body can be gzipped; in such case derive the stream from <a href="#HTTP2%2FCORE:GZIP-DECODING-MIXIN%20CLASS" title="HTTP2/CORE:GZIP-DECODING-MIXIN CLASS"><code>GZIP-DECODING-MIXIN</code></a>.</p>

<p><a id="x-28HTTP2-2FCORE-3AAPPLY-DATA-FRAME-20GENERIC-FUNCTION-29"></a>
<a id="HTTP2%2FCORE:APPLY-DATA-FRAME%20GENERIC-FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/core/frames/data.lisp#L257">[generic-function]</a></span> <span class="reference-object"><a href="#HTTP2%2FCORE:APPLY-DATA-FRAME%20GENERIC-FUNCTION" >APPLY-DATA-FRAME</a></span></span> <span class="locative-args">STREAM PAYLOAD START END</span></span></p>

<p><code>STREAM</code> (a HTTP/2 stream) should process received <code>PAYLOAD</code> from the data
frame from <code>START</code> to <code>END</code>.</p></li>
</ul>

<p><a id="x-28HTTP2-2FCORE-3AAPPLY-TEXT-DATA-FRAME-20GENERIC-FUNCTION-29"></a>
<a id="HTTP2%2FCORE:APPLY-TEXT-DATA-FRAME%20GENERIC-FUNCTION"></a></p>

<ul>
<li><span class=reference-bullet><span class=reference><span class="locative-type">[generic-function]</span> <span class="reference-object"><a href="#HTTP2%2FCORE:APPLY-TEXT-DATA-FRAME%20GENERIC-FUNCTION" >APPLY-TEXT-DATA-FRAME</a></span></span> <span class="locative-args">STREAM TEXT</span></span></li>
</ul>

<p><a id="x-28HTTP2-2FCORE-3AAPPLY-DATA-FRAME-20-28METHOD-20-28HTTP2-2FCORE-3AUTF8-PARSER-MIXIN-20T-20T-20T-29-29-29"></a>
<a id="HTTP2%2FCORE:APPLY-DATA-FRAME%20%28METHOD%20%28HTTP2%2FCORE:UTF8-PARSER-MIXIN%20T%20T%20T%29%29"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/core/utf8.lisp#L44">[method]</a></span> <span class="reference-object"><a href="#HTTP2%2FCORE:APPLY-DATA-FRAME%20%28METHOD%20%28HTTP2%2FCORE:UTF8-PARSER-MIXIN%20T%20T%20T%29%29" >APPLY-DATA-FRAME</a></span></span> <span class="locative-args">(STREAM <a href="#HTTP2%2FCORE:UTF8-PARSER-MIXIN%20CLASS" title="HTTP2/CORE:UTF8-PARSER-MIXIN CLASS"><code>UTF8-PARSER-MIXIN</code></a>) PAYLOAD START END</span></span></p>

<p>When headers satisfy <a href="#HTTP2%2FCORE:IS-UTF8-P%20FUNCTION" title="HTTP2/CORE:IS-UTF8-P FUNCTION"><code>IS-UTF8-P</code></a>, convert the the binary frame to text (taking
care about UTF-8 characters possibly split between frames) and call
<a href="#HTTP2%2FCORE:APPLY-TEXT-DATA-FRAME%20GENERIC-FUNCTION" title="HTTP2/CORE:APPLY-TEXT-DATA-FRAME GENERIC-FUNCTION"><code>APPLY-TEXT-DATA-FRAME</code></a> on it.</p></li>
</ul>

<p><a id="x-28HTTP2-2FCORE-3ABODY-COLLECTING-MIXIN-20CLASS-29"></a>
<a id="HTTP2%2FCORE:BODY-COLLECTING-MIXIN%20CLASS"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/core/frames/data.lisp#L173">[class]</a></span> <span class="reference-object"><a href="#HTTP2%2FCORE:BODY-COLLECTING-MIXIN%20CLASS" >BODY-COLLECTING-MIXIN</a></span></span></span></p>

<p>Mixin to collect all payload parts to one string.</p></li>
</ul>

<p><a id="x-28HTTP2-2FCORE-3AAPPLY-DATA-FRAME-20-28METHOD-20-28HTTP2-2FCORE-3ABODY-COLLECTING-MIXIN-20T-20T-20T-29-29-29"></a>
<a id="HTTP2%2FCORE:APPLY-DATA-FRAME%20%28METHOD%20%28HTTP2%2FCORE:BODY-COLLECTING-MIXIN%20T%20T%20T%29%29"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/core/frames/data.lisp#L257">[method]</a></span> <span class="reference-object"><a href="#HTTP2%2FCORE:APPLY-DATA-FRAME%20%28METHOD%20%28HTTP2%2FCORE:BODY-COLLECTING-MIXIN%20T%20T%20T%29%29" >APPLY-DATA-FRAME</a></span></span> <span class="locative-args">(STREAM <a href="#HTTP2%2FCORE:BODY-COLLECTING-MIXIN%20CLASS" title="HTTP2/CORE:BODY-COLLECTING-MIXIN CLASS"><code>BODY-COLLECTING-MIXIN</code></a>) DATA START END</span></span></p>

<p>Concatenate received data to the <code>BODY</code> slot of the object.</p></li>
</ul>

<p><a id="x-28HTTP2-2FCORE-3AUTF8-PARSER-MIXIN-20CLASS-29"></a>
<a id="HTTP2%2FCORE:UTF8-PARSER-MIXIN%20CLASS"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/core/utf8.lisp#L37">[class]</a></span> <span class="reference-object"><a href="#HTTP2%2FCORE:UTF8-PARSER-MIXIN%20CLASS" >UTF8-PARSER-MIXIN</a></span></span></span></p>

<p>Defines a method on <a href="#HTTP2%2FCORE:APPLY-DATA-FRAME%20GENERIC-FUNCTION" title="HTTP2/CORE:APPLY-DATA-FRAME GENERIC-FUNCTION"><code>APPLY-DATA-FRAME</code></a> that, if <code>CONTENT-TYPE</code> indicates UTF-8,
reads octets, converts them to UTF-8 text, and calls <a href="#HTTP2%2FCORE:APPLY-TEXT-DATA-FRAME%20GENERIC-FUNCTION" title="HTTP2/CORE:APPLY-TEXT-DATA-FRAME GENERIC-FUNCTION"><code>APPLY-TEXT-DATA-FRAME</code></a> on
the stream and the text.</p></li>
</ul>

<p><a id="x-28HTTP2-2FCORE-3AIS-UTF8-P-20FUNCTION-29"></a>
<a id="HTTP2%2FCORE:IS-UTF8-P%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/core/utf8.lisp#L20">[function]</a></span> <span class="reference-object"><a href="#HTTP2%2FCORE:IS-UTF8-P%20FUNCTION" >IS-UTF8-P</a></span></span> <span class="locative-args">HEADERS</span></span></p>

<p>Test headers to see if the encoding is UTF-8.</p></li>
</ul>

<p><a id="x-28HTTP2-2FCORE-3AGZIP-DECODING-MIXIN-20CLASS-29"></a>
<a id="HTTP2%2FCORE:GZIP-DECODING-MIXIN%20CLASS"></a></p>

<ul>
<li><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/core/gzip-decode.lisp#L3">[class]</a></span> <span class="reference-object"><a href="#HTTP2%2FCORE:GZIP-DECODING-MIXIN%20CLASS" >GZIP-DECODING-MIXIN</a></span></span></span></li>
</ul>

<p><a id="x-28HTTP2-2FCORE-3AAPPLY-DATA-FRAME-20-28METHOD-20-3AAROUND-20-28HTTP2-2FCORE-3AGZIP-DECODING-MIXIN-20T-20T-20T-29-29-29"></a>
<a id="HTTP2%2FCORE:APPLY-DATA-FRAME%20%28METHOD%20:AROUND%20%28HTTP2%2FCORE:GZIP-DECODING-MIXIN%20T%20T%20T%29%29"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/core/gzip-decode.lisp#L11">[method]</a></span> <span class="reference-object"><a href="#HTTP2%2FCORE:APPLY-DATA-FRAME%20%28METHOD%20:AROUND%20%28HTTP2%2FCORE:GZIP-DECODING-MIXIN%20T%20T%20T%29%29" >APPLY-DATA-FRAME</a></span></span> <span class="locative-args">AROUND (STREAM <a href="#HTTP2%2FCORE:GZIP-DECODING-MIXIN%20CLASS" title="HTTP2/CORE:GZIP-DECODING-MIXIN CLASS"><code>GZIP-DECODING-MIXIN</code></a>) PAYLOAD START END</span></span></p>

<p>When there is a <code>Content-Encoding: gzip</code> header, decompress the data and call next
<code>APPLY-DATA-FRAME</code> methods.</p></li>
</ul>

<p><a id="x-28HTTP2-2FCORE-3ATEXT-COLLECTING-STREAM-20CLASS-29"></a>
<a id="HTTP2%2FCORE:TEXT-COLLECTING-STREAM%20CLASS"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/core/frames/data.lisp#L183">[class]</a></span> <span class="reference-object"><a href="#HTTP2%2FCORE:TEXT-COLLECTING-STREAM%20CLASS" >TEXT-COLLECTING-STREAM</a></span></span></span></p>

<p>Mixin that collect all the received body (possibly unzipped data frames
converted to proper encoding) into its <code>TEXT</code> slot.</p></li>
</ul>

<p>Data to write are send by <code>WRITE-DATA-FRAME-MULTI</code> or <code>WRITE-DATA-FRAME</code>. These do
not take into account limits set up by the peer, so use <code>WRITE-BINARY-PAYLOAD</code> instead.</p>

<p>Send and received octets are accounted for and must be within some limits (window).</p>

<p>User in most cases probably prefers not to care about windows and data frames,
and binary vs text and content encoding and compression of the data.</p>

<p>This poses several topics:</p>

<ul>
<li><p>Overlay a Common Lisp stream over data frames. This is done using gray
  streams, see XXX.</p></li>
<li><p>Handle window management. The problem is that we do not
  want to block an individual stream handler. So the options I can see are:</p></li>
<li><p>We can actually ignore the issue, if the size of the output is small, it would
  work. You can <code>WRITE-DATA-FRAME</code> if you need to send binary data up to 16384 octets (or more
  if negotiated with the per)</p></li>
<li><p>We can signal error when the output is too big, and let the application code handle that.
  The application would need a callback to resume operations when the window is open again.
  Problem - it complicates the application.</p></li>
<li><p>We can buffer all the input and send it when there is an opportunity automatically.
  Problem - potentially conses a lot.</p></li>
</ul>

<p>Starting from the low-level, options are:</p>

<p><a id="x-28HTTP2-2FCORE-3A-40STREAMS-20MGL-PAX-3ASECTION-29"></a>
<a id="HTTP2%2FCORE:@STREAMS%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#HTTP2%2FCORE:@DATA%20MGL-PAX:SECTION" title="Data and flow control">&#8592;</a> <a href="#HTTP2%2FCORE:@IMPLEMENTATION%2FOVERVIEW%20MGL-PAX:SECTION" title="Overview">&#8593;</a> <a href="#HTTP2%2FCORE:@BASE-CLASSES%20MGL-PAX:SECTION" title="Classes">&#8594;</a> <a href="#HTTP2%2FCORE:@STREAMS%20MGL-PAX:SECTION" title="HTTP/2 Streams">&#8634;</a> <a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/core/classes.lisp#L109">&#955;</a></span></span></p>

<h4><a href="#HTTP2%2FCORE:@STREAMS%20MGL-PAX:SECTION">4.1.2 HTTP/2 Streams</a></h4>

<p><a id="x-28HTTP2-2FCORE-3AHTTP2-STREAM-MINIMAL-20CLASS-29"></a>
<a id="HTTP2%2FCORE:HTTP2-STREAM-MINIMAL%20CLASS"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/core/frames/http2-stream.lisp#L17">[class]</a></span> <span class="reference-object"><a href="#HTTP2%2FCORE:HTTP2-STREAM-MINIMAL%20CLASS" >HTTP2-STREAM-MINIMAL</a></span></span> <span class="locative-args">FLOW-CONTROL-MIXIN</span></span></p>

<p>Part of representation of HTTP/2 stream needed to read and write frames.</p></li>
</ul>

<p><a id="x-28HTTP2-2FCORE-3AHTTP2-STREAM-20CLASS-29"></a>
<a id="HTTP2%2FCORE:HTTP2-STREAM%20CLASS"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/core/classes.lisp#L116">[class]</a></span> <span class="reference-object"><a href="#HTTP2%2FCORE:HTTP2-STREAM%20CLASS" >HTTP2-STREAM</a></span></span> <span class="locative-args"><a href="#HTTP2%2FCORE:HTTP2-STREAM-MINIMAL%20CLASS" title="HTTP2/CORE:HTTP2-STREAM-MINIMAL CLASS">HTTP2-STREAM-MINIMAL</a> FLOW-CONTROL-MIXIN</span></span></p>

<p>Representation of HTTP/2 stream. See RFC7540.</p></li>
</ul>

<p><a id="x-28HTTP2-2FUTILS-3AHTTP2-STREAM-STATE-20TYPE-29"></a>
<a id="HTTP2%2FUTILS:HTTP2-STREAM-STATE%20TYPE"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/core/utils.lisp#L243">[type]</a></span> <span class="reference-object"><a href="#HTTP2%2FUTILS:HTTP2-STREAM-STATE%20TYPE" >HTTP2-STREAM-STATE</a></span></span></span></p>

<p>HTTP2 state. Currently a symbol from fixed list, might be a number in future.</p></li>
</ul>

<p><a id="x-28HTTP2-2FCORE-3ASTREAM-COLLECTION-20CLASS-29"></a>
<a id="HTTP2%2FCORE:STREAM-COLLECTION%20CLASS"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/core/frames/http2-stream.lisp#L28">[class]</a></span> <span class="reference-object"><a href="#HTTP2%2FCORE:STREAM-COLLECTION%20CLASS" >STREAM-COLLECTION</a></span></span></span></p>

<p>Live connections can have zero, one or more <a href="#HTTP2%2FCORE:@STREAMS%20MGL-PAX:SECTION" title="HTTP/2 Streams">HTTP/2 Streams</a> that are not closed, and
can generate new ones.</p></li>
</ul>

<p><a id="x-28HTTP2-2FCORE-3ASERVER-STREAM-20CLASS-29"></a>
<a id="HTTP2%2FCORE:SERVER-STREAM%20CLASS"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/core/classes.lisp#L142">[class]</a></span> <span class="reference-object"><a href="#HTTP2%2FCORE:SERVER-STREAM%20CLASS" >SERVER-STREAM</a></span></span> <span class="locative-args"><a href="#HTTP2%2FCORE:HTTP2-STREAM%20CLASS" title="HTTP2/CORE:HTTP2-STREAM CLASS">HTTP2-STREAM</a></span></span></p>

<p>Server streams need to track attributes from the client headers such as <code>PATH</code>.</p></li>
</ul>

<p><a id="x-28HTTP2-2FCORE-3A-40BASE-CLASSES-20MGL-PAX-3ASECTION-29"></a>
<a id="HTTP2%2FCORE:@BASE-CLASSES%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#HTTP2%2FCORE:@STREAMS%20MGL-PAX:SECTION" title="HTTP/2 Streams">&#8592;</a> <a href="#HTTP2%2FCORE:@IMPLEMENTATION%2FOVERVIEW%20MGL-PAX:SECTION" title="Overview">&#8593;</a> <a href="#HTTP2%2FCORE:@WRITE-DATA-HANDLING%20MGL-PAX:SECTION" title="Writing frames">&#8594;</a> <a href="#HTTP2%2FCORE:@BASE-CLASSES%20MGL-PAX:SECTION" title="Classes">&#8634;</a> <a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/core/classes.lisp#L168">&#955;</a></span></span></p>

<h4><a href="#HTTP2%2FCORE:@BASE-CLASSES%20MGL-PAX:SECTION">4.1.3 Classes</a></h4>

<p>There are two parallel class hierarchies, one for HTTP2 connections, one for the HTTP2 streams.</p>

<p>In general, CLIENT- and SERVER- classes implement required minimal behaviour for
the client, resp. server, and are supposed to be stable, while VANILLA classes
implement &quot;typical&quot; or best practice behaviour and may change in time. They
should be good for ad-hoc activities and experiments; for stable behaviour,
make your class using appropriate mixins.</p>

<p><img src="./classes.svg" alt="Class hierarchy" /></p>

<p><a id="x-28HTTP2-2FCORE-3ACLIENT-HTTP2-CONNECTION-20CLASS-29"></a>
<a id="HTTP2%2FCORE:CLIENT-HTTP2-CONNECTION%20CLASS"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/core/classes.lisp#L96">[class]</a></span> <span class="reference-object"><a href="#HTTP2%2FCORE:CLIENT-HTTP2-CONNECTION%20CLASS" >CLIENT-HTTP2-CONNECTION</a></span></span> <span class="locative-args"><a href="#HTTP2%2FCORE:HTTP2-CONNECTION%20CLASS" title="HTTP2/CORE:HTTP2-CONNECTION CLASS">HTTP2-CONNECTION</a></span></span></p>

<p>Client connections initiate odd-numbered streams.</p></li>
</ul>

<p><a id="x-28HTTP2-2FCORE-3AGET-STREAM-CLASS-20GENERIC-FUNCTION-29"></a>
<a id="HTTP2%2FCORE:GET-STREAM-CLASS%20GENERIC-FUNCTION"></a></p>

<ul>
<li><span class=reference-bullet><span class=reference><span class="locative-type">[generic-function]</span> <span class="reference-object"><a href="#HTTP2%2FCORE:GET-STREAM-CLASS%20GENERIC-FUNCTION" >GET-STREAM-CLASS</a></span></span> <span class="locative-args">OBJECT</span></span></li>
</ul>

<p><a id="x-28HTTP2-2FCORE-3AOPEN-HTTP2-STREAM-20FUNCTION-29"></a>
<a id="HTTP2%2FCORE:OPEN-HTTP2-STREAM%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/core/classes.lisp#L252">[function]</a></span> <span class="reference-object"><a href="#HTTP2%2FCORE:OPEN-HTTP2-STREAM%20FUNCTION" >OPEN-HTTP2-STREAM</a></span></span> <span class="locative-args">CONNECTION HEADERS &amp;KEY END-STREAM (END-HEADERS <code>T</code>) STREAM-PARS</span></span></p>

<p>Open HTTP/2 stream (typically, from client side) by sending headers.</p>

<ul>
<li><p><code>STREAM-PARS</code> are used as parameters for creating new stream instance.</p></li>
<li><p><code>HEADERS</code> are headers to be send for the client. You can use REQUEST-HEADERS to
  get necessary headers.</p></li>
<li><p><code>END-HEADERS</code> is aflag to the server that no more headers would be sent; true by default.</p></li>
<li><p><code>END-STREAM</code> is a flag to the server that there would be no payload.</p></li>
</ul></li>
</ul>

<p><a id="x-28HTTP2-2FCORE-3AGET-NETWORK-STREAM-20GENERIC-FUNCTION-29"></a>
<a id="HTTP2%2FCORE:GET-NETWORK-STREAM%20GENERIC-FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/core/classes.lisp#L196">[generic-function]</a></span> <span class="reference-object"><a href="#HTTP2%2FCORE:GET-NETWORK-STREAM%20GENERIC-FUNCTION" >GET-NETWORK-STREAM</a></span></span> <span class="locative-args">OBJECT</span></span></p>

<p>Get network stream for the object.</p></li>
</ul>

<p><a id="x-28HTTP2-2FCORE-3AGET-BODY-20GENERIC-FUNCTION-29"></a>
<a id="HTTP2%2FCORE:GET-BODY%20GENERIC-FUNCTION"></a></p>

<ul>
<li><span class=reference-bullet><span class=reference><span class="locative-type">[generic-function]</span> <span class="reference-object"><a href="#HTTP2%2FCORE:GET-BODY%20GENERIC-FUNCTION" >GET-BODY</a></span></span> <span class="locative-args">OBJECT</span></span></li>
</ul>

<p><a id="x-28HTTP2-2FCORE-3AGET-PATH-20GENERIC-FUNCTION-29"></a>
<a id="HTTP2%2FCORE:GET-PATH%20GENERIC-FUNCTION"></a></p>

<ul>
<li><span class=reference-bullet><span class=reference><span class="locative-type">[generic-function]</span> <span class="reference-object"><a href="#HTTP2%2FCORE:GET-PATH%20GENERIC-FUNCTION" >GET-PATH</a></span></span> <span class="locative-args">OBJECT</span></span></li>
</ul>

<p><a id="x-28HTTP2-2FCORE-3ASEND-HEADERS-20FUNCTION-29"></a>
<a id="HTTP2%2FCORE:SEND-HEADERS%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/core/classes.lisp#L268">[function]</a></span> <span class="reference-object"><a href="#HTTP2%2FCORE:SEND-HEADERS%20FUNCTION" >SEND-HEADERS</a></span></span> <span class="locative-args">STREAM HEADERS &amp;KEY END-STREAM (END-HEADERS <code>T</code>) &amp;ALLOW-OTHER-KEYS</span></span></p>

<p>Send <code>HEADERS</code> to a HTTP2 stream. The stream is returned.</p>

<p>The <code>END-HEADERS</code> and <code>END-STREAM</code> allow to set the appropriate flags.</p>

<p>Inside HANDLER macro, this names a function that has the <code>STREAM</code>
argument implicit and only <code>HEADERS</code> and key parameters are to be provided.</p></li>
</ul>

<p><a id="x-28HTTP2-2FCORE-3AGET-METHOD-20GENERIC-FUNCTION-29"></a>
<a id="HTTP2%2FCORE:GET-METHOD%20GENERIC-FUNCTION"></a></p>

<ul>
<li><span class=reference-bullet><span class=reference><span class="locative-type">[generic-function]</span> <span class="reference-object"><a href="#HTTP2%2FCORE:GET-METHOD%20GENERIC-FUNCTION" >GET-METHOD</a></span></span> <span class="locative-args">OBJECT</span></span></li>
</ul>

<p><a id="x-28HTTP2-2FCORE-3AGET-HEADERS-20GENERIC-FUNCTION-29"></a>
<a id="HTTP2%2FCORE:GET-HEADERS%20GENERIC-FUNCTION"></a></p>

<ul>
<li><span class=reference-bullet><span class=reference><span class="locative-type">[generic-function]</span> <span class="reference-object"><a href="#HTTP2%2FCORE:GET-HEADERS%20GENERIC-FUNCTION" >GET-HEADERS</a></span></span> <span class="locative-args">OBJECT</span></span></li>
</ul>

<p><a id="x-28HTTP2-2FCORE-3AGET-SCHEME-20GENERIC-FUNCTION-29"></a>
<a id="HTTP2%2FCORE:GET-SCHEME%20GENERIC-FUNCTION"></a></p>

<ul>
<li><span class=reference-bullet><span class=reference><span class="locative-type">[generic-function]</span> <span class="reference-object"><a href="#HTTP2%2FCORE:GET-SCHEME%20GENERIC-FUNCTION" >GET-SCHEME</a></span></span> <span class="locative-args">OBJECT</span></span></li>
</ul>

<p><a id="x-28HTTP2-2FCORE-3AGET-AUTHORITY-20GENERIC-FUNCTION-29"></a>
<a id="HTTP2%2FCORE:GET-AUTHORITY%20GENERIC-FUNCTION"></a></p>

<ul>
<li><span class=reference-bullet><span class=reference><span class="locative-type">[generic-function]</span> <span class="reference-object"><a href="#HTTP2%2FCORE:GET-AUTHORITY%20GENERIC-FUNCTION" >GET-AUTHORITY</a></span></span> <span class="locative-args">OBJECT</span></span></li>
</ul>

<p><a id="x-28HTTP2-2FCORE-3ATIMESHIFT-PINGING-CONNECTION-20CLASS-29"></a>
<a id="HTTP2%2FCORE:TIMESHIFT-PINGING-CONNECTION%20CLASS"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/core/classes.lisp#L201">[class]</a></span> <span class="reference-object"><a href="#HTTP2%2FCORE:TIMESHIFT-PINGING-CONNECTION%20CLASS" >TIMESHIFT-PINGING-CONNECTION</a></span></span></span></p>

<p>A mixin that implements specific <code>DO-PING</code> and <code>DO-PONG</code> so that the RTT is printed
after <code>DO-PING</code> is send.</p></li>
</ul>

<p><a id="x-28HTTP2-2FCORE-3A-40WRITE-DATA-HANDLING-20MGL-PAX-3ASECTION-29"></a>
<a id="HTTP2%2FCORE:@WRITE-DATA-HANDLING%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#HTTP2%2FCORE:@BASE-CLASSES%20MGL-PAX:SECTION" title="Classes">&#8592;</a> <a href="#HTTP2%2FCORE:@IMPLEMENTATION%2FOVERVIEW%20MGL-PAX:SECTION" title="Overview">&#8593;</a> <a href="#HTTP2%2FCORE:@DATA-RECEIVED%20MGL-PAX:SECTION" title="Processing data frames">&#8594;</a> <a href="#HTTP2%2FCORE:@WRITE-DATA-HANDLING%20MGL-PAX:SECTION" title="Writing frames">&#8634;</a> <a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/core/classes.lisp#L208">&#955;</a></span></span></p>

<h4><a href="#HTTP2%2FCORE:@WRITE-DATA-HANDLING%20MGL-PAX:SECTION">4.1.4 Writing frames</a></h4>

<p>There are two strategies how to write data that a connection produces - either
write them to a stream, or store them for future. They specialize <a href="#HTTP2%2FCORE:QUEUE-FRAME%20GENERIC-FUNCTION" title="HTTP2/CORE:QUEUE-FRAME GENERIC-FUNCTION"><code>QUEUE-FRAME</code></a>
generic function to actually store the data.</p>

<p><a id="x-28HTTP2-2FCORE-3AWRITE-BUFFER-CONNECTION-MIXIN-20CLASS-29"></a>
<a id="HTTP2%2FCORE:WRITE-BUFFER-CONNECTION-MIXIN%20CLASS"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/core/frames.lisp#L27">[class]</a></span> <span class="reference-object"><a href="#HTTP2%2FCORE:WRITE-BUFFER-CONNECTION-MIXIN%20CLASS" >WRITE-BUFFER-CONNECTION-MIXIN</a></span></span></span></p>

<p>Stores queued frame in a per-connection write buffer. The internals of the
buffer are opaque.</p></li>
</ul>

<p><a id="x-28HTTP2-2FCORE-3ASTREAM-BASED-CONNECTION-MIXIN-20CLASS-29"></a>
<a id="HTTP2%2FCORE:STREAM-BASED-CONNECTION-MIXIN%20CLASS"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/core/frames.lisp#L37">[class]</a></span> <span class="reference-object"><a href="#HTTP2%2FCORE:STREAM-BASED-CONNECTION-MIXIN%20CLASS" >STREAM-BASED-CONNECTION-MIXIN</a></span></span></span></p>

<p>A mixin for connections that read frames from and write to Common Lisp stream (in
slot <code>NETWORK-STREAM</code>).</p></li>
</ul>

<p><a id="x-28HTTP2-2FCORE-3AQUEUE-FRAME-20GENERIC-FUNCTION-29"></a>
<a id="HTTP2%2FCORE:QUEUE-FRAME%20GENERIC-FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/core/frames.lisp#L54">[generic-function]</a></span> <span class="reference-object"><a href="#HTTP2%2FCORE:QUEUE-FRAME%20GENERIC-FUNCTION" >QUEUE-FRAME</a></span></span> <span class="locative-args">CONNECTION FRAME</span></span></p>

<p>Send or queue <code>FRAME</code> (octet vector) to the connection.</p>

<p>Each connection has to actually implement it.</p>

<p>Existing implementations are for:</p>

<ul>
<li><p><a href="#HTTP2%2FCORE:STREAM-BASED-CONNECTION-MIXIN%20CLASS" title="HTTP2/CORE:STREAM-BASED-CONNECTION-MIXIN CLASS"><code>STREAM-BASED-CONNECTION-MIXIN</code></a>, where the data are simply sent to the List stream,</p></li>
<li><p><a href="#HTTP2%2FCORE:WRITE-BUFFER-CONNECTION-MIXIN%20CLASS" title="HTTP2/CORE:WRITE-BUFFER-CONNECTION-MIXIN CLASS"><code>WRITE-BUFFER-CONNECTION-MIXIN</code></a>, where the data are pushed to a buffer.</p></li>
</ul></li>
</ul>

<p><a id="x-28HTTP2-2FCORE-3APARSE-CLIENT-PREFACE-20FUNCTION-29"></a>
<a id="HTTP2%2FCORE:PARSE-CLIENT-PREFACE%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/core/classes.lisp#L388">[function]</a></span> <span class="reference-object"><a href="#HTTP2%2FCORE:PARSE-CLIENT-PREFACE%20FUNCTION" >PARSE-CLIENT-PREFACE</a></span></span> <span class="locative-args">CONNECTION BUFFER</span></span></p>

<p>Parse client preface.</p>

<p>Check that buffer contains a client preface, or raise an error.</p>

<p>Then write the initial settings frame, and expect normal frame. Actually, this should be a settings frame, but this is not enforced now.</p></li>
</ul>

<p><a id="x-28HTTP2-2FCORE-3A-2BCLIENT-PREFACE-START-2B-20VARIABLE-29"></a>
<a id="HTTP2%2FCORE:+CLIENT-PREFACE-START+%20VARIABLE"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/core/classes.lisp#L383">[variable]</a></span> <span class="reference-object"><a href="#HTTP2%2FCORE:+CLIENT-PREFACE-START+%20VARIABLE" >+CLIENT-PREFACE-START+</a></span></span> <span class="locative-args">#(80 82 73 32 42 32 72 84 84 80 47 50 46 48 13 10 13 10 83 77 13 10 13 10)</span></span></p>

<p>The client connection preface starts with a sequence of 24 octets, which in hex notation is this. That is, the connection preface starts with the string
&quot;PRI * HTTP/2.0rnrnSMrnrn&quot;).</p></li>
</ul>

<p><a id="x-28HTTP2-2FCORE-3A-40DATA-RECEIVED-20MGL-PAX-3ASECTION-29"></a>
<a id="HTTP2%2FCORE:@DATA-RECEIVED%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#HTTP2%2FCORE:@WRITE-DATA-HANDLING%20MGL-PAX:SECTION" title="Writing frames">&#8592;</a> <a href="#HTTP2%2FCORE:@IMPLEMENTATION%2FOVERVIEW%20MGL-PAX:SECTION" title="Overview">&#8593;</a> <a href="#HTTP2%2FHPACK:@HPACK-API%20MGL-PAX:SECTION" title="HPACK - RFC7541 implementation.">&#8594;</a> <a href="#HTTP2%2FCORE:@DATA-RECEIVED%20MGL-PAX:SECTION" title="Processing data frames">&#8634;</a> <a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/core/classes.lisp#L220">&#955;</a></span></span></p>

<h4><a href="#HTTP2%2FCORE:@DATA-RECEIVED%20MGL-PAX:SECTION">4.1.5 Processing data frames</a></h4>

<p><a id="x-28HTTP2-2FCORE-3AAPPLY-DATA-FRAME-20GENERIC-FUNCTION-29"></a>
<a id="HTTP2%2FCORE:APPLY-DATA-FRAME%20GENERIC-FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/core/frames/data.lisp#L257">[generic-function]</a></span> <span class="reference-object"><a href="#HTTP2%2FCORE:APPLY-DATA-FRAME%20GENERIC-FUNCTION" >APPLY-DATA-FRAME</a></span></span> <span class="locative-args">STREAM PAYLOAD START END</span></span></p>

<p><code>STREAM</code> (a HTTP/2 stream) should process received <code>PAYLOAD</code> from the data
frame from <code>START</code> to <code>END</code>.</p></li>
</ul>

<p><a id="x-28HTTP2-2FCORE-3AAPPLY-DATA-FRAME-20-28METHOD-20-28T-20T-20T-20T-29-29-29"></a>
<a id="HTTP2%2FCORE:APPLY-DATA-FRAME%20%28METHOD%20%28T%20T%20T%20T%29%29"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/core/frames/data.lisp#L257">[method]</a></span> <span class="reference-object"><a href="#HTTP2%2FCORE:APPLY-DATA-FRAME%20%28METHOD%20%28T%20T%20T%20T%29%29" >APPLY-DATA-FRAME</a></span></span> <span class="locative-args">STREAM PAYLOAD START END</span></span></p>

<p>Just ignore the data and warn about it.</p></li>
</ul>

<p><a id="x-28HTTP2-2FCORE-3ABODY-COLLECTING-MIXIN-20CLASS-29"></a>
<a id="HTTP2%2FCORE:BODY-COLLECTING-MIXIN%20CLASS"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/core/frames/data.lisp#L173">[class]</a></span> <span class="reference-object"><a href="#HTTP2%2FCORE:BODY-COLLECTING-MIXIN%20CLASS" >BODY-COLLECTING-MIXIN</a></span></span></span></p>

<p>Mixin to collect all payload parts to one string.</p></li>
</ul>

<p><a id="x-28HTTP2-2FCORE-3AAPPLY-DATA-FRAME-20-28METHOD-20-28HTTP2-2FCORE-3ABODY-COLLECTING-MIXIN-20T-20T-20T-29-29-29"></a>
<a id="HTTP2%2FCORE:APPLY-DATA-FRAME%20%28METHOD%20%28HTTP2%2FCORE:BODY-COLLECTING-MIXIN%20T%20T%20T%29%29"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/core/frames/data.lisp#L257">[method]</a></span> <span class="reference-object"><a href="#HTTP2%2FCORE:APPLY-DATA-FRAME%20%28METHOD%20%28HTTP2%2FCORE:BODY-COLLECTING-MIXIN%20T%20T%20T%29%29" >APPLY-DATA-FRAME</a></span></span> <span class="locative-args">(STREAM <a href="#HTTP2%2FCORE:BODY-COLLECTING-MIXIN%20CLASS" title="HTTP2/CORE:BODY-COLLECTING-MIXIN CLASS"><code>BODY-COLLECTING-MIXIN</code></a>) DATA START END</span></span></p>

<p>Concatenate received data to the <code>BODY</code> slot of the object.</p></li>
</ul>

<p><a id="x-28HTTP2-2FHPACK-3A-40HPACK-API-20MGL-PAX-3ASECTION-29"></a>
<a id="HTTP2%2FHPACK:@HPACK-API%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#HTTP2%2FCORE:@DATA-RECEIVED%20MGL-PAX:SECTION" title="Processing data frames">&#8592;</a> <a href="implementation.html" title="Implementation details (not part of API)">&#8593;</a> <a href="#HTTP2%2FCORE:@DATA%20MGL-PAX:SECTION" title="Data and flow control">&#8594;</a> <a href="#HTTP2%2FHPACK:@HPACK-API%20MGL-PAX:SECTION" title="HPACK - RFC7541 implementation.">&#8634;</a> <a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/core/hpack.lisp#L5">&#955;</a></span></span></p>

<h3><a href="#HTTP2%2FHPACK:@HPACK-API%20MGL-PAX:SECTION">4.2 HPACK - RFC7541 implementation.</a></h3>

<h6>[in package HTTP2/HPACK]</h6>

<p>HTTP2 headers can be compressed - and implementation needs to be able to decompress - by two (or maybe three) ways:</p>

<ul>
<li><p>Headers (with or without value) in static headers table (defined in RFC) can be replaced by appropriate a code,</p></li>
<li><p>Headers being sent out may be cached and after first use in dynamic headers table and later replaced by a code,</p></li>
<li><p>Headers as string can be Huffman compressed.</p></li>
</ul>

<p><a id="x-28HTTP2-2FHPACK-3ADO-DECODED-HEADERS-20FUNCTION-29"></a>
<a id="HTTP2%2FHPACK:DO-DECODED-HEADERS%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/core/hpack.lisp#L457">[function]</a></span> <span class="reference-object"><a href="#HTTP2%2FHPACK:DO-DECODED-HEADERS%20FUNCTION" >DO-DECODED-HEADERS</a></span></span> <span class="locative-args">FN CONTEXT DATA &amp;OPTIONAL (START 0) (END (<a href="http://www.lispworks.com/documentation/HyperSpec/Body/f_length.htm" title="LENGTH (MGL-PAX:CLHS FUNCTION)"><code>LENGTH</code></a> <code>DATA</code>))</span></span></p>

<p>Call <code>FN</code> on each header decoded from <code>DATA</code> between <code>START</code> and <code>END</code>.</p>

<p>Return nil if the complete headers were processed, or index to first unprocessed octet.</p></li>
</ul>

<p><a id="x-28HTTP2-2FHPACK-3ACOMPILE-HEADERS-20FUNCTION-29"></a>
<a id="HTTP2%2FHPACK:COMPILE-HEADERS%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/core/hpack.lisp#L298">[function]</a></span> <span class="reference-object"><a href="#HTTP2%2FHPACK:COMPILE-HEADERS%20FUNCTION" >COMPILE-HEADERS</a></span></span> <span class="locative-args">HEADERS CONTEXT</span></span></p>

<p>Compile headers with given <code>CONTEXT</code> to an array. Context can be <code>NIL</code>; if it is
not, the headers are stored in the dynamic table and the <code>CONTEXT</code> it is updated
appropriately.</p>

<p>Each header is a list of form (<code>NAME</code> <code>VALUE</code> <a href="http://www.lispworks.com/documentation/HyperSpec/Body/03_da.htm" title="&quot;3.4.1&quot; (MGL-PAX:CLHS MGL-PAX:SECTION)"><code>&amp;KEY</code></a> <code>HUFFMAN</code> <code>INDEX</code>):</p>

<ul>
<li><p><code>NO-INDEX</code> indicates that it should be stored in the dynamic table (if possible), should not, or use the NEVER encoding (value :never),</p></li>
<li><p><code>HUFFMAN</code> to use huffman encoding</p></li>
</ul></li>
</ul>

<p><a id="x-28HTTP2-2FHPACK-3A-2AUSE-HUFFMAN-CODING-BY-DEFAULT-2A-20VARIABLE-29"></a>
<a id="HTTP2%2FHPACK:*USE-HUFFMAN-CODING-BY-DEFAULT*%20VARIABLE"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/core/hpack.lisp#L194">[variable]</a></span> <span class="reference-object"><a href="#HTTP2%2FHPACK:*USE-HUFFMAN-CODING-BY-DEFAULT*%20VARIABLE" >*USE-HUFFMAN-CODING-BY-DEFAULT*</a></span></span> <span class="locative-args">:MAYBE</span></span></p>

<p>Is set, the headers are by default huffman-encoded. Special value :maybe means
whatever is shorter, plain encoding in case of draw.</p></li>
</ul>

<p>Dynamic headers table is implemented by <a href="#HTTP2%2FHPACK:HPACK-CONTEXT%20CLASS" title="HTTP2/HPACK:HPACK-CONTEXT CLASS"><code>HPACK-CONTEXT</code></a> class that should be
from API point considered opaque. Context is needed twice for each connection,
once for each direction of communication.</p>

<p><a id="x-28HTTP2-2FHPACK-3AHPACK-CONTEXT-20CLASS-29"></a>
<a id="HTTP2%2FHPACK:HPACK-CONTEXT%20CLASS"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/core/hpack.lisp#L50">[class]</a></span> <span class="reference-object"><a href="#HTTP2%2FHPACK:HPACK-CONTEXT%20CLASS" >HPACK-CONTEXT</a></span></span></span></p>

<p>Dynamic tables implementation: they are stored in an adjustable array, with
[0] element storing first element initially (indexed by s+1), and (s+k)th element after k
insertions.</p>

<p>After deletion of D elements, element s+k is stored on index D, element s+1
on index</p>

<p>&lt;----------  Index Address Space ----------&gt;
  &lt;-- Static  Table --&gt;  &lt;--   Dynamic Table --&gt;
  +---+-----------+---+  +-----+-----------+-----+
  | 1 |    ...    | s |  |s+1+D|    ...    |s+k+D| ...deleted...
  +---+-----------+---+  +-----+-----------+-----+
                            k                D                 0
                         &lt;----- table aref index --------------&gt;
                         ^                   |
                         |                   V
                  Insertion Point      Dropping Point</p></li>
</ul>

<p><a id="x-28HTTP2-2FHPACK-3AUPDATE-DYNAMIC-TABLE-SIZE-20FUNCTION-29"></a>
<a id="HTTP2%2FHPACK:UPDATE-DYNAMIC-TABLE-SIZE%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/core/hpack.lisp#L154">[function]</a></span> <span class="reference-object"><a href="#HTTP2%2FHPACK:UPDATE-DYNAMIC-TABLE-SIZE%20FUNCTION" >UPDATE-DYNAMIC-TABLE-SIZE</a></span></span> <span class="locative-args">CONTEXT NEW-SIZE</span></span></p>

<p>Update dynamic table for new size that is smaller than the previous one. This is
called after receiving appropriate settings update.</p>

<p>Zero size means evict completely; in this case the new vector can be cleaned</p></li>
</ul>

<p><a id="x-28HTTP2-2FHPACK-3AGET-DYNAMIC-TABLE-SIZE-20GENERIC-FUNCTION-29"></a>
<a id="HTTP2%2FHPACK:GET-DYNAMIC-TABLE-SIZE%20GENERIC-FUNCTION"></a></p>

<ul>
<li><span class=reference-bullet><span class=reference><span class="locative-type">[generic-function]</span> <span class="reference-object"><a href="#HTTP2%2FHPACK:GET-DYNAMIC-TABLE-SIZE%20GENERIC-FUNCTION" >GET-DYNAMIC-TABLE-SIZE</a></span></span> <span class="locative-args">OBJECT</span></span></li>
</ul>

<p><a id="x-28HTTP2-2FHPACK-3AGET-UPDATES-NEEDED-20GENERIC-FUNCTION-29"></a>
<a id="HTTP2%2FHPACK:GET-UPDATES-NEEDED%20GENERIC-FUNCTION"></a></p>

<ul>
<li><span class=reference-bullet><span class=reference><span class="locative-type">[generic-function]</span> <span class="reference-object"><a href="#HTTP2%2FHPACK:GET-UPDATES-NEEDED%20GENERIC-FUNCTION" >GET-UPDATES-NEEDED</a></span></span> <span class="locative-args">OBJECT</span></span></li>
</ul>

<p><a id="x-28HTTP2-2FCORE-3A-40DATA-20MGL-PAX-3ASECTION-29"></a>
<a id="HTTP2%2FCORE:@DATA%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#HTTP2%2FCORE:@CONNECTIONS%20MGL-PAX:SECTION" title="HTTP/2 Connections">&#8592;</a> <a href="#HTTP2%2FCORE:@CONNECTIONS%20MGL-PAX:SECTION" title="HTTP/2 Connections">&#8593;</a> <a href="#HTTP2%2FCORE:@STREAMS%20MGL-PAX:SECTION" title="HTTP/2 Streams">&#8594;</a> <a href="#HTTP2%2FCORE:@DATA%20MGL-PAX:SECTION" title="Data and flow control">&#8634;</a> <a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/core/frames/data.lisp#L121">&#955;</a></span></span></p>

<h3><a href="#HTTP2%2FCORE:@DATA%20MGL-PAX:SECTION">4.3 Data and flow control</a></h3>

<h6>[in package HTTP2/CORE]</h6>

<p>HTTP streams can receive some data (content, body). We can see treat in
several ways:</p>

<ul>
<li><p>we can collect the data till all is received (end of stream from the peer) and
  then process it as whole. If you need this, use <a href="#HTTP2%2FCORE:BODY-COLLECTING-MIXIN%20CLASS" title="HTTP2/CORE:BODY-COLLECTING-MIXIN CLASS"><code>BODY-COLLECTING-MIXIN</code></a> class and <a href="#HTTP2%2FCORE:GET-BODY%20GENERIC-FUNCTION" title="HTTP2/CORE:GET-BODY GENERIC-FUNCTION"><code>GET-BODY</code></a> function, or
  <a href="#HTTP2%2FCORE:TEXT-COLLECTING-STREAM%20CLASS" title="HTTP2/CORE:TEXT-COLLECTING-STREAM CLASS"><code>TEXT-COLLECTING-STREAM</code></a> class and <a href="index.html#HTTP2%2FCORE:HTTP-STREAM-TO-STRING%20FUNCTION" title="HTTP2/CORE:HTTP-STREAM-TO-STRING FUNCTION"><code>HTTP-STREAM-TO-STRING</code></a> function.</p></li>
<li><p>we may want to do something with each recieved chunk of data as soon as it
  arrives. In this case, specialize <a href="#HTTP2%2FCORE:APPLY-DATA-FRAME%20GENERIC-FUNCTION" title="HTTP2/CORE:APPLY-DATA-FRAME GENERIC-FUNCTION"><code>APPLY-DATA-FRAME</code></a> or <a href="#HTTP2%2FCORE:APPLY-TEXT-DATA-FRAME%20GENERIC-FUNCTION" title="HTTP2/CORE:APPLY-TEXT-DATA-FRAME GENERIC-FUNCTION"><code>APPLY-TEXT-DATA-FRAME</code></a>.</p></li>
</ul>

<p>In both cases, one may want to work either with a string or with octets. The
latter is default, for the former use <a href="#HTTP2%2FCORE:UTF8-PARSER-MIXIN%20CLASS" title="HTTP2/CORE:UTF8-PARSER-MIXIN CLASS"><code>UTF8-PARSER-MIXIN</code></a> and/or
<a href="index.html#HTTP2%2FCORE:FALLBACK-ALL-IS-ASCII%20CLASS" title="HTTP2/CORE:FALLBACK-ALL-IS-ASCII CLASS"><code>FALLBACK-ALL-IS-ASCII</code></a>.</p>

<p>The body can be gzipped; in such case derive the stream from <a href="#HTTP2%2FCORE:GZIP-DECODING-MIXIN%20CLASS" title="HTTP2/CORE:GZIP-DECODING-MIXIN CLASS"><code>GZIP-DECODING-MIXIN</code></a>.</p>

<p><a id="x-28HTTP2-2FCORE-3AAPPLY-DATA-FRAME-20GENERIC-FUNCTION-29"></a>
<a id="HTTP2%2FCORE:APPLY-DATA-FRAME%20GENERIC-FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/core/frames/data.lisp#L257">[generic-function]</a></span> <span class="reference-object"><a href="#HTTP2%2FCORE:APPLY-DATA-FRAME%20GENERIC-FUNCTION" >APPLY-DATA-FRAME</a></span></span> <span class="locative-args">STREAM PAYLOAD START END</span></span></p>

<p><code>STREAM</code> (a HTTP/2 stream) should process received <code>PAYLOAD</code> from the data
frame from <code>START</code> to <code>END</code>.</p></li>
</ul>

<p><a id="x-28HTTP2-2FCORE-3AAPPLY-TEXT-DATA-FRAME-20GENERIC-FUNCTION-29"></a>
<a id="HTTP2%2FCORE:APPLY-TEXT-DATA-FRAME%20GENERIC-FUNCTION"></a></p>

<ul>
<li><span class=reference-bullet><span class=reference><span class="locative-type">[generic-function]</span> <span class="reference-object"><a href="#HTTP2%2FCORE:APPLY-TEXT-DATA-FRAME%20GENERIC-FUNCTION" >APPLY-TEXT-DATA-FRAME</a></span></span> <span class="locative-args">STREAM TEXT</span></span></li>
</ul>

<p><a id="x-28HTTP2-2FCORE-3AAPPLY-DATA-FRAME-20-28METHOD-20-28HTTP2-2FCORE-3AUTF8-PARSER-MIXIN-20T-20T-20T-29-29-29"></a>
<a id="HTTP2%2FCORE:APPLY-DATA-FRAME%20%28METHOD%20%28HTTP2%2FCORE:UTF8-PARSER-MIXIN%20T%20T%20T%29%29"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/core/utf8.lisp#L44">[method]</a></span> <span class="reference-object"><a href="#HTTP2%2FCORE:APPLY-DATA-FRAME%20%28METHOD%20%28HTTP2%2FCORE:UTF8-PARSER-MIXIN%20T%20T%20T%29%29" >APPLY-DATA-FRAME</a></span></span> <span class="locative-args">(STREAM <a href="#HTTP2%2FCORE:UTF8-PARSER-MIXIN%20CLASS" title="HTTP2/CORE:UTF8-PARSER-MIXIN CLASS"><code>UTF8-PARSER-MIXIN</code></a>) PAYLOAD START END</span></span></p>

<p>When headers satisfy <a href="#HTTP2%2FCORE:IS-UTF8-P%20FUNCTION" title="HTTP2/CORE:IS-UTF8-P FUNCTION"><code>IS-UTF8-P</code></a>, convert the the binary frame to text (taking
care about UTF-8 characters possibly split between frames) and call
<a href="#HTTP2%2FCORE:APPLY-TEXT-DATA-FRAME%20GENERIC-FUNCTION" title="HTTP2/CORE:APPLY-TEXT-DATA-FRAME GENERIC-FUNCTION"><code>APPLY-TEXT-DATA-FRAME</code></a> on it.</p></li>
</ul>

<p><a id="x-28HTTP2-2FCORE-3ABODY-COLLECTING-MIXIN-20CLASS-29"></a>
<a id="HTTP2%2FCORE:BODY-COLLECTING-MIXIN%20CLASS"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/core/frames/data.lisp#L173">[class]</a></span> <span class="reference-object"><a href="#HTTP2%2FCORE:BODY-COLLECTING-MIXIN%20CLASS" >BODY-COLLECTING-MIXIN</a></span></span></span></p>

<p>Mixin to collect all payload parts to one string.</p></li>
</ul>

<p><a id="x-28HTTP2-2FCORE-3AAPPLY-DATA-FRAME-20-28METHOD-20-28HTTP2-2FCORE-3ABODY-COLLECTING-MIXIN-20T-20T-20T-29-29-29"></a>
<a id="HTTP2%2FCORE:APPLY-DATA-FRAME%20%28METHOD%20%28HTTP2%2FCORE:BODY-COLLECTING-MIXIN%20T%20T%20T%29%29"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/core/frames/data.lisp#L257">[method]</a></span> <span class="reference-object"><a href="#HTTP2%2FCORE:APPLY-DATA-FRAME%20%28METHOD%20%28HTTP2%2FCORE:BODY-COLLECTING-MIXIN%20T%20T%20T%29%29" >APPLY-DATA-FRAME</a></span></span> <span class="locative-args">(STREAM <a href="#HTTP2%2FCORE:BODY-COLLECTING-MIXIN%20CLASS" title="HTTP2/CORE:BODY-COLLECTING-MIXIN CLASS"><code>BODY-COLLECTING-MIXIN</code></a>) DATA START END</span></span></p>

<p>Concatenate received data to the <code>BODY</code> slot of the object.</p></li>
</ul>

<p><a id="x-28HTTP2-2FCORE-3AUTF8-PARSER-MIXIN-20CLASS-29"></a>
<a id="HTTP2%2FCORE:UTF8-PARSER-MIXIN%20CLASS"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/core/utf8.lisp#L37">[class]</a></span> <span class="reference-object"><a href="#HTTP2%2FCORE:UTF8-PARSER-MIXIN%20CLASS" >UTF8-PARSER-MIXIN</a></span></span></span></p>

<p>Defines a method on <a href="#HTTP2%2FCORE:APPLY-DATA-FRAME%20GENERIC-FUNCTION" title="HTTP2/CORE:APPLY-DATA-FRAME GENERIC-FUNCTION"><code>APPLY-DATA-FRAME</code></a> that, if <code>CONTENT-TYPE</code> indicates UTF-8,
reads octets, converts them to UTF-8 text, and calls <a href="#HTTP2%2FCORE:APPLY-TEXT-DATA-FRAME%20GENERIC-FUNCTION" title="HTTP2/CORE:APPLY-TEXT-DATA-FRAME GENERIC-FUNCTION"><code>APPLY-TEXT-DATA-FRAME</code></a> on
the stream and the text.</p></li>
</ul>

<p><a id="x-28HTTP2-2FCORE-3AIS-UTF8-P-20FUNCTION-29"></a>
<a id="HTTP2%2FCORE:IS-UTF8-P%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/core/utf8.lisp#L20">[function]</a></span> <span class="reference-object"><a href="#HTTP2%2FCORE:IS-UTF8-P%20FUNCTION" >IS-UTF8-P</a></span></span> <span class="locative-args">HEADERS</span></span></p>

<p>Test headers to see if the encoding is UTF-8.</p></li>
</ul>

<p><a id="x-28HTTP2-2FCORE-3AGZIP-DECODING-MIXIN-20CLASS-29"></a>
<a id="HTTP2%2FCORE:GZIP-DECODING-MIXIN%20CLASS"></a></p>

<ul>
<li><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/core/gzip-decode.lisp#L3">[class]</a></span> <span class="reference-object"><a href="#HTTP2%2FCORE:GZIP-DECODING-MIXIN%20CLASS" >GZIP-DECODING-MIXIN</a></span></span></span></li>
</ul>

<p><a id="x-28HTTP2-2FCORE-3AAPPLY-DATA-FRAME-20-28METHOD-20-3AAROUND-20-28HTTP2-2FCORE-3AGZIP-DECODING-MIXIN-20T-20T-20T-29-29-29"></a>
<a id="HTTP2%2FCORE:APPLY-DATA-FRAME%20%28METHOD%20:AROUND%20%28HTTP2%2FCORE:GZIP-DECODING-MIXIN%20T%20T%20T%29%29"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/core/gzip-decode.lisp#L11">[method]</a></span> <span class="reference-object"><a href="#HTTP2%2FCORE:APPLY-DATA-FRAME%20%28METHOD%20:AROUND%20%28HTTP2%2FCORE:GZIP-DECODING-MIXIN%20T%20T%20T%29%29" >APPLY-DATA-FRAME</a></span></span> <span class="locative-args">AROUND (STREAM <a href="#HTTP2%2FCORE:GZIP-DECODING-MIXIN%20CLASS" title="HTTP2/CORE:GZIP-DECODING-MIXIN CLASS"><code>GZIP-DECODING-MIXIN</code></a>) PAYLOAD START END</span></span></p>

<p>When there is a <code>Content-Encoding: gzip</code> header, decompress the data and call next
<code>APPLY-DATA-FRAME</code> methods.</p></li>
</ul>

<p><a id="x-28HTTP2-2FCORE-3ATEXT-COLLECTING-STREAM-20CLASS-29"></a>
<a id="HTTP2%2FCORE:TEXT-COLLECTING-STREAM%20CLASS"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/core/frames/data.lisp#L183">[class]</a></span> <span class="reference-object"><a href="#HTTP2%2FCORE:TEXT-COLLECTING-STREAM%20CLASS" >TEXT-COLLECTING-STREAM</a></span></span></span></p>

<p>Mixin that collect all the received body (possibly unzipped data frames
converted to proper encoding) into its <code>TEXT</code> slot.</p></li>
</ul>

<p>Data to write are send by <code>WRITE-DATA-FRAME-MULTI</code> or <code>WRITE-DATA-FRAME</code>. These do
not take into account limits set up by the peer, so use <code>WRITE-BINARY-PAYLOAD</code> instead.</p>

<p>Send and received octets are accounted for and must be within some limits (window).</p>

<p>User in most cases probably prefers not to care about windows and data frames,
and binary vs text and content encoding and compression of the data.</p>

<p>This poses several topics:</p>

<ul>
<li><p>Overlay a Common Lisp stream over data frames. This is done using gray
  streams, see XXX.</p></li>
<li><p>Handle window management. The problem is that we do not
  want to block an individual stream handler. So the options I can see are:</p></li>
<li><p>We can actually ignore the issue, if the size of the output is small, it would
  work. You can <code>WRITE-DATA-FRAME</code> if you need to send binary data up to 16384 octets (or more
  if negotiated with the per)</p></li>
<li><p>We can signal error when the output is too big, and let the application code handle that.
  The application would need a callback to resume operations when the window is open again.
  Problem - it complicates the application.</p></li>
<li><p>We can buffer all the input and send it when there is an opportunity automatically.
  Problem - potentially conses a lot.</p></li>
</ul>

<p>Starting from the low-level, options are:</p>

<p><a id="x-28HTTP2-2FSERVER-3A-40SERVER-REFERENCE-20MGL-PAX-3ASECTION-29"></a>
<a id="HTTP2%2FSERVER:@SERVER-REFERENCE%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="reference.html#HTTP2%2FCLIENT:@CLIENT-API%20MGL-PAX:SECTION" title="HTTP/2 client API">&#8592;</a> <a href="reference.html" title="API documentation">&#8593;</a> <a href="#HTTP2%2FSERVER:@DISPATCHERS%20MGL-PAX:SECTION" title="Server classes">&#8594;</a> <a href="#HTTP2%2FSERVER:@SERVER-REFERENCE%20MGL-PAX:SECTION" title="Server API reference">&#8634;</a> <a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/server/dispatch.lisp#L416">&#955;</a></span></span></p>

<h3><a href="#HTTP2%2FSERVER:@SERVER-REFERENCE%20MGL-PAX:SECTION">4.4 Server API reference</a></h3>

<h6>[in package HTTP2/SERVER with nicknames HTTP2/SERVER/SHARED, HTTP2/SERVER/POLL, HTTP2/SERVER/THREADED]</h6>

<p><a id="x-28HTTP2-2FSERVER-3A-40DISPATCHERS-20MGL-PAX-3ASECTION-29"></a>
<a id="HTTP2%2FSERVER:@DISPATCHERS%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#HTTP2%2FSERVER:@SERVER-REFERENCE%20MGL-PAX:SECTION" title="Server API reference">&#8592;</a> <a href="#HTTP2%2FSERVER:@SERVER-REFERENCE%20MGL-PAX:SECTION" title="Server API reference">&#8593;</a> <a href="#HTTP2%2FSERVER:@SERVER-MIXINS%20MGL-PAX:SECTION" title="Server mixins and component classes">&#8594;</a> <a href="#HTTP2%2FSERVER:@DISPATCHERS%20MGL-PAX:SECTION" title="Server classes">&#8634;</a> <a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/server/dispatch.lisp#L420">&#955;</a></span></span></p>

<h4><a href="#HTTP2%2FSERVER:@DISPATCHERS%20MGL-PAX:SECTION">4.4.1 Server classes</a></h4>

<p>The server behaviour is defined by used dispatcher (server class). The class is
specified as a parameter to the <code>START</code> function.</p>

<p>The dispatcher should be a subclass of the <a href="#HTTP2%2FSERVER:BASE-DISPATCHER%20CLASS" title="HTTP2/SERVER:BASE-DISPATCHER CLASS"><code>BASE-DISPATCHER</code></a> and can use predefined mixins to specify:</p>

<ul>
<li><p>How to handle multiple connections (<a href="#HTTP2%2FSERVER:THREADED-DISPATCHER%20CLASS" title="HTTP2/SERVER:THREADED-DISPATCHER CLASS"><code>THREADED-DISPATCHER</code></a>, <a href="#HTTP2%2FSERVER:POLL-DISPATCHER-MIXIN%20CLASS" title="HTTP2/SERVER:POLL-DISPATCHER-MIXIN CLASS"><code>POLL-DISPATCHER-MIXIN</code></a>, <a href="#HTTP2%2FSERVER:SINGLE-CLIENT-DISPATCHER%20CLASS" title="HTTP2/SERVER:SINGLE-CLIENT-DISPATCHER CLASS"><code>SINGLE-CLIENT-DISPATCHER</code></a>)</p></li>
<li><p>For threaded dispatcher to add <code>TLS</code> wrapping (<a href="#HTTP2%2FSERVER:TLS-DISPATCHER-MIXIN%20CLASS" title="HTTP2/SERVER:TLS-DISPATCHER-MIXIN CLASS"><code>TLS-DISPATCHER-MIXIN</code></a>)</p></li>
<li><p>To run the server in separate thread (<a href="#HTTP2%2FSERVER:DETACHED-SERVER-MIXIN%20CLASS" title="HTTP2/SERVER:DETACHED-SERVER-MIXIN CLASS"><code>DETACHED-SERVER-MIXIN</code></a>).</p></li>
</ul>

<p>Some predefined combinations are below.</p>

<p><a id="x-28HTTP2-2FSERVER-3APOLL-DISPATCHER-20CLASS-29"></a>
<a id="HTTP2%2FSERVER:POLL-DISPATCHER%20CLASS"></a></p>

<ul>
<li><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/server/poll-server.lisp#L975">[class]</a></span> <span class="reference-object"><a href="#HTTP2%2FSERVER:POLL-DISPATCHER%20CLASS" >POLL-DISPATCHER</a></span></span> <span class="locative-args"><a href="#HTTP2%2FSERVER:POLL-DISPATCHER-MIXIN%20CLASS" title="HTTP2/SERVER:POLL-DISPATCHER-MIXIN CLASS">POLL-DISPATCHER-MIXIN</a> <a href="#HTTP2%2FSERVER:TLS-DISPATCHER-MIXIN%20CLASS" title="HTTP2/SERVER:TLS-DISPATCHER-MIXIN CLASS">TLS-DISPATCHER-MIXIN</a></span></span></li>
</ul>

<p><a id="x-28HTTP2-2FSERVER-3ADETACHED-POLL-DISPATCHER-20CLASS-29"></a>
<a id="HTTP2%2FSERVER:DETACHED-POLL-DISPATCHER%20CLASS"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/server/poll-server.lisp#L982">[class]</a></span> <span class="reference-object"><a href="#HTTP2%2FSERVER:DETACHED-POLL-DISPATCHER%20CLASS" >DETACHED-POLL-DISPATCHER</a></span></span> <span class="locative-args"><a href="#HTTP2%2FSERVER:DETACHED-SERVER-MIXIN%20CLASS" title="HTTP2/SERVER:DETACHED-SERVER-MIXIN CLASS">DETACHED-SERVER-MIXIN</a> <a href="#HTTP2%2FSERVER:POLL-DISPATCHER%20CLASS" title="HTTP2/SERVER:POLL-DISPATCHER CLASS">POLL-DISPATCHER</a></span></span></p>

<p>Detached version of the <a href="#HTTP2%2FSERVER:POLL-DISPATCHER%20CLASS" title="HTTP2/SERVER:POLL-DISPATCHER CLASS"><code>POLL-DISPATCHER</code></a>.</p></li>
</ul>

<p><a id="x-28HTTP2-2FSERVER-3ADETACHED-TLS-THREADED-DISPATCHER-20CLASS-29"></a>
<a id="HTTP2%2FSERVER:DETACHED-TLS-THREADED-DISPATCHER%20CLASS"></a></p>

<ul>
<li><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/server/threaded.lisp#L11">[class]</a></span> <span class="reference-object"><a href="#HTTP2%2FSERVER:DETACHED-TLS-THREADED-DISPATCHER%20CLASS" >DETACHED-TLS-THREADED-DISPATCHER</a></span></span> <span class="locative-args"><a href="#HTTP2%2FSERVER:DETACHED-SERVER-MIXIN%20CLASS" title="HTTP2/SERVER:DETACHED-SERVER-MIXIN CLASS">DETACHED-SERVER-MIXIN</a> <a href="#HTTP2%2FSERVER:TLS-THREADED-DISPATCHER%20CLASS" title="HTTP2/SERVER:TLS-THREADED-DISPATCHER CLASS">TLS-THREADED-DISPATCHER</a></span></span></li>
</ul>

<p><a id="x-28HTTP2-2FSERVER-3ATLS-THREADED-DISPATCHER-20CLASS-29"></a>
<a id="HTTP2%2FSERVER:TLS-THREADED-DISPATCHER%20CLASS"></a></p>

<ul>
<li><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/server/threaded.lisp#L8">[class]</a></span> <span class="reference-object"><a href="#HTTP2%2FSERVER:TLS-THREADED-DISPATCHER%20CLASS" >TLS-THREADED-DISPATCHER</a></span></span> <span class="locative-args"><a href="#HTTP2%2FSERVER:TLS-DISPATCHER-MIXIN%20CLASS" title="HTTP2/SERVER:TLS-DISPATCHER-MIXIN CLASS">TLS-DISPATCHER-MIXIN</a> <a href="#HTTP2%2FSERVER:THREADED-DISPATCHER%20CLASS" title="HTTP2/SERVER:THREADED-DISPATCHER CLASS">THREADED-DISPATCHER</a></span></span></li>
</ul>

<p><a id="x-28HTTP2-2FSERVER-3ATLS-SINGLE-CLIENT-DISPATCHER-20CLASS-29"></a>
<a id="HTTP2%2FSERVER:TLS-SINGLE-CLIENT-DISPATCHER%20CLASS"></a></p>

<ul>
<li><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/server/dispatch.lisp#L319">[class]</a></span> <span class="reference-object"><a href="#HTTP2%2FSERVER:TLS-SINGLE-CLIENT-DISPATCHER%20CLASS" >TLS-SINGLE-CLIENT-DISPATCHER</a></span></span> <span class="locative-args"><a href="#HTTP2%2FSERVER:TLS-DISPATCHER-MIXIN%20CLASS" title="HTTP2/SERVER:TLS-DISPATCHER-MIXIN CLASS">TLS-DISPATCHER-MIXIN</a> <a href="#HTTP2%2FSERVER:SINGLE-CLIENT-DISPATCHER%20CLASS" title="HTTP2/SERVER:SINGLE-CLIENT-DISPATCHER CLASS">SINGLE-CLIENT-DISPATCHER</a></span></span></li>
</ul>

<p><a id="x-28HTTP2-2FSERVER-3ADETACHED-TLS-SINGLE-CLIENT-DISPATCHER-20CLASS-29"></a>
<a id="HTTP2%2FSERVER:DETACHED-TLS-SINGLE-CLIENT-DISPATCHER%20CLASS"></a></p>

<ul>
<li><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/server/dispatch.lisp#L322">[class]</a></span> <span class="reference-object"><a href="#HTTP2%2FSERVER:DETACHED-TLS-SINGLE-CLIENT-DISPATCHER%20CLASS" >DETACHED-TLS-SINGLE-CLIENT-DISPATCHER</a></span></span> <span class="locative-args"><a href="#HTTP2%2FSERVER:DETACHED-SERVER-MIXIN%20CLASS" title="HTTP2/SERVER:DETACHED-SERVER-MIXIN CLASS">DETACHED-SERVER-MIXIN</a> <a href="#HTTP2%2FSERVER:TLS-SINGLE-CLIENT-DISPATCHER%20CLASS" title="HTTP2/SERVER:TLS-SINGLE-CLIENT-DISPATCHER CLASS">TLS-SINGLE-CLIENT-DISPATCHER</a></span></span></li>
</ul>

<p><a id="x-28HTTP2-2FSERVER-3A-2AVANILLA-SERVER-DISPATCHER-2A-20VARIABLE-29"></a>
<a id="HTTP2%2FSERVER:*VANILLA-SERVER-DISPATCHER*%20VARIABLE"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/server/socket-dispatcher.lisp#L61">[variable]</a></span> <span class="reference-object"><a href="#HTTP2%2FSERVER:*VANILLA-SERVER-DISPATCHER*%20VARIABLE" >*VANILLA-SERVER-DISPATCHER*</a></span></span> <span class="locative-args">NIL</span></span></p>

<p>Default value of the server dispatcher. One of <a href="#HTTP2%2FSERVER:DETACHED-TLS-THREADED-DISPATCHER%20CLASS" title="HTTP2/SERVER:DETACHED-TLS-THREADED-DISPATCHER CLASS"><code>DETACHED-TLS-THREADED-DISPATCHER</code></a>
ot <a href="#HTTP2%2FSERVER:POLL-DISPATCHER%20CLASS" title="HTTP2/SERVER:POLL-DISPATCHER CLASS"><code>POLL-DISPATCHER</code></a></p></li>
</ul>

<p><a id="x-28HTTP2-2FSERVER-3A-40SERVER-MIXINS-20MGL-PAX-3ASECTION-29"></a>
<a id="HTTP2%2FSERVER:@SERVER-MIXINS%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#HTTP2%2FSERVER:@DISPATCHERS%20MGL-PAX:SECTION" title="Server classes">&#8592;</a> <a href="#HTTP2%2FSERVER:@DISPATCHERS%20MGL-PAX:SECTION" title="Server classes">&#8593;</a> <a href="reference.html#HTTP2%2FSERVER:@LOGGING%20MGL-PAX:SECTION" title="Logging support">&#8594;</a> <a href="#HTTP2%2FSERVER:@SERVER-MIXINS%20MGL-PAX:SECTION" title="Server mixins and component classes">&#8634;</a> <a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/server/dispatch.lisp#L440">&#955;</a></span></span></p>

<h5><a href="#HTTP2%2FSERVER:@SERVER-MIXINS%20MGL-PAX:SECTION">Server mixins and component classes</a></h5>

<p><a id="x-28HTTP2-2FSERVER-3ABASE-DISPATCHER-20CLASS-29"></a>
<a id="HTTP2%2FSERVER:BASE-DISPATCHER%20CLASS"></a></p>

<ul>
<li><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/server/socket-dispatcher.lisp#L174">[class]</a></span> <span class="reference-object"><a href="#HTTP2%2FSERVER:BASE-DISPATCHER%20CLASS" >BASE-DISPATCHER</a></span></span></span></li>
</ul>

<p><a id="x-28HTTP2-2FSERVER-3ATHREADED-DISPATCHER-20CLASS-29"></a>
<a id="HTTP2%2FSERVER:THREADED-DISPATCHER%20CLASS"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/server/threaded.lisp#L3">[class]</a></span> <span class="reference-object"><a href="#HTTP2%2FSERVER:THREADED-DISPATCHER%20CLASS" >THREADED-DISPATCHER</a></span></span> <span class="locative-args"><a href="#HTTP2%2FSERVER:BASE-DISPATCHER%20CLASS" title="HTTP2/SERVER:BASE-DISPATCHER CLASS">BASE-DISPATCHER</a></span></span></p>

<p>Specialize <code>DO-NEW-CONNECTION</code> to process new connections each in a separate thread. </p></li>
</ul>

<p><a id="x-28HTTP2-2FSERVER-3APOLL-DISPATCHER-MIXIN-20CLASS-29"></a>
<a id="HTTP2%2FSERVER:POLL-DISPATCHER-MIXIN%20CLASS"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/server/poll-server.lisp#L951">[class]</a></span> <span class="reference-object"><a href="#HTTP2%2FSERVER:POLL-DISPATCHER-MIXIN%20CLASS" >POLL-DISPATCHER-MIXIN</a></span></span> <span class="locative-args">FDSET-MANAGER</span></span></p>

<p>Uses poll to listen to a set of clients and handle arriving packets in a single
thread.</p>

<p>Maximum number of clients is fixed (by default <em>fdset-size</em>, by default
10). Additional clients wait until one of existing client leaves.</p>

<p>Timeouts can be specified for polling.</p></li>
</ul>

<p><a id="x-28HTTP2-2FSERVER-3ASINGLE-CLIENT-DISPATCHER-20CLASS-29"></a>
<a id="HTTP2%2FSERVER:SINGLE-CLIENT-DISPATCHER%20CLASS"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/server/socket-dispatcher.lisp#L190">[class]</a></span> <span class="reference-object"><a href="#HTTP2%2FSERVER:SINGLE-CLIENT-DISPATCHER%20CLASS" >SINGLE-CLIENT-DISPATCHER</a></span></span> <span class="locative-args"><a href="#HTTP2%2FSERVER:BASE-DISPATCHER%20CLASS" title="HTTP2/SERVER:BASE-DISPATCHER CLASS">BASE-DISPATCHER</a></span></span></p>

<p>Handle the connection while doing nothing else.</p>

<p>Serve just one client at time: when it connects, read the incoming requests and
handle them as they arrive. When the client sends go-away frame, close the
connection and be ready to serve another client.</p>

<p>Obviously, there is little overhead and this version is actually pretty fast -
for one client and in ideal conditions (especially with request pilelining).</p></li>
</ul>

<p><a id="x-28HTTP2-2FSERVER-3ATLS-DISPATCHER-MIXIN-20CLASS-29"></a>
<a id="HTTP2%2FSERVER:TLS-DISPATCHER-MIXIN%20CLASS"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/server/dispatch.lisp#L457">[class]</a></span> <span class="reference-object"><a href="#HTTP2%2FSERVER:TLS-DISPATCHER-MIXIN%20CLASS" >TLS-DISPATCHER-MIXIN</a></span></span> <span class="locative-args">EASY-CERTIFICATED-CONTEXT-MIXIN H2-SERVER-CONTEXT-MIXIN <a href="#HTTP2%2FSERVER:BASE-DISPATCHER%20CLASS" title="HTTP2/SERVER:BASE-DISPATCHER CLASS">BASE-DISPATCHER</a></span></span></p>

<p>Specializes <code>SERVER-SOCKET-STREAM</code> to add <code>TLS</code> layer to the created sockets,
and <code>START-SERVER-ON-SOCKET</code> to use a context created by MAKE-HTTP2-TLS-CONTEXT.</p></li>
</ul>

<p><a id="x-28HTTP2-2FSERVER-3ADETACHED-SERVER-MIXIN-20CLASS-29"></a>
<a id="HTTP2%2FSERVER:DETACHED-SERVER-MIXIN%20CLASS"></a></p>

<ul>
<li><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/server/socket-dispatcher.lisp#L31">[class]</a></span> <span class="reference-object"><a href="#HTTP2%2FSERVER:DETACHED-SERVER-MIXIN%20CLASS" >DETACHED-SERVER-MIXIN</a></span></span></span></li>
</ul>

<p><a id="x-28HTTP2-2FSERVER-3A-40ASYNC-SERVER-20MGL-PAX-3ASECTION-29"></a>
<a id="HTTP2%2FSERVER:@ASYNC-SERVER%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#HTTP2%2FSERVER:@SERVER-MIXINS%20MGL-PAX:SECTION" title="Server mixins and component classes">&#8592;</a> <a href="implementation.html" title="Implementation details (not part of API)">&#8593;</a> <a href="#HTTP2%2FSERVER:@APP-INTERFACE%20MGL-PAX:SECTION" title="Interface to the polling server">&#8594;</a> <a href="#HTTP2%2FSERVER:@ASYNC-SERVER%20MGL-PAX:SECTION" title="Polling server overview">&#8634;</a> <a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/server/poll-server.lisp#L4">&#955;</a></span></span></p>

<h3><a href="#HTTP2%2FSERVER:@ASYNC-SERVER%20MGL-PAX:SECTION">4.5 Polling server overview</a></h3>

<h6>[in package HTTP2/SERVER with nicknames HTTP2/SERVER/SHARED, HTTP2/SERVER/POLL, HTTP2/SERVER/THREADED]</h6>

<p><a id="x-28HTTP2-2FSERVER-3A-40APP-INTERFACE-20MGL-PAX-3ASECTION-29"></a>
<a id="HTTP2%2FSERVER:@APP-INTERFACE%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#HTTP2%2FSERVER:@ASYNC-SERVER%20MGL-PAX:SECTION" title="Polling server overview">&#8592;</a> <a href="#HTTP2%2FSERVER:@ASYNC-SERVER%20MGL-PAX:SECTION" title="Polling server overview">&#8593;</a> <a href="#HTTP2%2FSERVER:@REQUEST-HANDLING%20MGL-PAX:SECTION" title="Client actions loop (implementation)">&#8594;</a> <a href="#HTTP2%2FSERVER:@APP-INTERFACE%20MGL-PAX:SECTION" title="Interface to the polling server">&#8634;</a> <a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/server/poll-server.lisp#L9">&#955;</a></span></span></p>

<h4><a href="#HTTP2%2FSERVER:@APP-INTERFACE%20MGL-PAX:SECTION">4.5.1 Interface to the polling server</a></h4>

<p><a href="#HTTP2%2FSERVER:POLL-DISPATCHER-MIXIN%20CLASS" title="HTTP2/SERVER:POLL-DISPATCHER-MIXIN CLASS"><code>POLL-DISPATCHER-MIXIN</code></a> tracks a pool of clients that are connected to a
socket. Each client has a user registered callback function and required number
of octets to have available to call the callback. Callbacks call
<a href="#HTTP2%2FSERVER:SEND-UNENCRYPTED-BYTES%20FUNCTION" title="HTTP2/SERVER:SEND-UNENCRYPTED-BYTES FUNCTION"><code>SEND-UNENCRYPTED-BYTES</code></a> to encrypt and send more data.</p>

<p>The central function is <code>SERVE-TLS</code> that orchestrates reading, decrypting,
encrypting and writing of data for all the sockets.</p>

<p><a id="x-28HTTP2-2FSERVER-3AGET-CLIENTS-20GENERIC-FUNCTION-29"></a>
<a id="HTTP2%2FSERVER:GET-CLIENTS%20GENERIC-FUNCTION"></a></p>

<ul>
<li><span class=reference-bullet><span class=reference><span class="locative-type">[generic-function]</span> <span class="reference-object"><a href="#HTTP2%2FSERVER:GET-CLIENTS%20GENERIC-FUNCTION" >GET-CLIENTS</a></span></span> <span class="locative-args">OBJECT</span></span></li>
</ul>

<p><a id="x-28HTTP2-2FSERVER-3ACLIENT-SSL-20-28MGL-PAX-3ASTRUCTURE-ACCESSOR-20HTTP2-2FSERVER-3ATLS-ENDPOINT-29-29"></a>
<a id="HTTP2%2FSERVER:CLIENT-SSL%20%28MGL-PAX:STRUCTURE-ACCESSOR%20HTTP2%2FSERVER:TLS-ENDPOINT%29"></a></p>

<ul>
<li><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/server/poll-server.lisp#L189">[structure-accessor]</a></span> <span class="reference-object"><a href="#HTTP2%2FSERVER:CLIENT-SSL%20%28MGL-PAX:STRUCTURE-ACCESSOR%20HTTP2%2FSERVER:TLS-ENDPOINT%29" >CLIENT-SSL</a></span></span> <span class="locative-args">TLS-ENDPOINT</span></span></li>
</ul>

<p><a id="x-28HTTP2-2FSERVER-3APOLL-DISPATCHER-MIXIN-20CLASS-29"></a>
<a id="HTTP2%2FSERVER:POLL-DISPATCHER-MIXIN%20CLASS"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/server/poll-server.lisp#L951">[class]</a></span> <span class="reference-object"><a href="#HTTP2%2FSERVER:POLL-DISPATCHER-MIXIN%20CLASS" >POLL-DISPATCHER-MIXIN</a></span></span> <span class="locative-args">FDSET-MANAGER</span></span></p>

<p>Uses poll to listen to a set of clients and handle arriving packets in a single
thread.</p>

<p>Maximum number of clients is fixed (by default <em>fdset-size</em>, by default
10). Additional clients wait until one of existing client leaves.</p>

<p>Timeouts can be specified for polling.</p></li>
</ul>

<p><a id="x-28HTTP2-2FSERVER-3APROCESS-CLIENT-SOCKETS-20FUNCTION-29"></a>
<a id="HTTP2%2FSERVER:PROCESS-CLIENT-SOCKETS%20FUNCTION"></a></p>

<ul>
<li><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/server/poll-server.lisp#L844">[function]</a></span> <span class="reference-object"><a href="#HTTP2%2FSERVER:PROCESS-CLIENT-SOCKETS%20FUNCTION" >PROCESS-CLIENT-SOCKETS</a></span></span> <span class="locative-args">NREAD DISPATCHER</span></span></li>
</ul>

<p><a id="x-28HTTP2-2FSERVER-3AADD-SOCKET-TO-FDSET-20FUNCTION-29"></a>
<a id="HTTP2%2FSERVER:ADD-SOCKET-TO-FDSET%20FUNCTION"></a></p>

<ul>
<li><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/server/poll-server.lisp#L797">[function]</a></span> <span class="reference-object"><a href="#HTTP2%2FSERVER:ADD-SOCKET-TO-FDSET%20FUNCTION" >ADD-SOCKET-TO-FDSET</a></span></span> <span class="locative-args">FDSET SOCKET CLIENT FD-IDX</span></span></li>
</ul>

<p><a id="x-28HTTP2-2FSERVER-3ASEND-UNENCRYPTED-BYTES-20FUNCTION-29"></a>
<a id="HTTP2%2FSERVER:SEND-UNENCRYPTED-BYTES%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/server/poll-server.lisp#L408">[function]</a></span> <span class="reference-object"><a href="#HTTP2%2FSERVER:SEND-UNENCRYPTED-BYTES%20FUNCTION" >SEND-UNENCRYPTED-BYTES</a></span></span> <span class="locative-args">CLIENT NEW-DATA COMMENT</span></span></p>

<p>Add new data to be encrypted and sent to client.</p>

<p>Data are buffered in the <code>ENCRYPT-BUF</code> of the client and when there is enough of
them they are encrypted.</p>

<p><code>NEW-DATA</code> are completely used up (can be dynamic-extent).</p></li>
</ul>

<p><a id="x-28HTTP2-2FSERVER-3AENCRYPT-AND-SEND-20FUNCTION-29"></a>
<a id="HTTP2%2FSERVER:ENCRYPT-AND-SEND%20FUNCTION"></a></p>

<ul>
<li><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/server/poll-server.lisp#L516">[function]</a></span> <span class="reference-object"><a href="#HTTP2%2FSERVER:ENCRYPT-AND-SEND%20FUNCTION" >ENCRYPT-AND-SEND</a></span></span> <span class="locative-args">CLIENT</span></span></li>
</ul>

<p><a id="x-28HTTP2-2FSERVER-3ASET-NEXT-ACTION-20FUNCTION-29"></a>
<a id="HTTP2%2FSERVER:SET-NEXT-ACTION%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/server/poll-server.lisp#L710">[function]</a></span> <span class="reference-object"><a href="#HTTP2%2FSERVER:SET-NEXT-ACTION%20FUNCTION" >SET-NEXT-ACTION</a></span></span> <span class="locative-args">CLIENT ACTION SIZE</span></span></p>

<p>Set action for next chunk of received data.</p></li>
</ul>

<p><a id="x-28HTTP2-2FSERVER-3AGET-POLL-TIMEOUT-20-28MGL-PAX-3AACCESSOR-20HTTP2-2FSERVER-3APOLL-DISPATCHER-MIXIN-29-29"></a>
<a id="HTTP2%2FSERVER:GET-POLL-TIMEOUT%20%28MGL-PAX:ACCESSOR%20HTTP2%2FSERVER:POLL-DISPATCHER-MIXIN%29"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/server/poll-server.lisp#L952">[accessor]</a></span> <span class="reference-object"><a href="#HTTP2%2FSERVER:GET-POLL-TIMEOUT%20%28MGL-PAX:ACCESSOR%20HTTP2%2FSERVER:POLL-DISPATCHER-MIXIN%29" >GET-POLL-TIMEOUT</a></span></span> <span class="locative-args"><a href="#HTTP2%2FSERVER:POLL-DISPATCHER-MIXIN%20CLASS" title="HTTP2/SERVER:POLL-DISPATCHER-MIXIN CLASS">POLL-DISPATCHER-MIXIN</a> (:POLL-TIMEOUT)</span></span></p>

<p>See <a href="#HTTP2%2FSERVER:*POLL-TIMEOUT*%20VARIABLE" title="HTTP2/SERVER:*POLL-TIMEOUT* VARIABLE"><code>*POLL-TIMEOUT*</code></a>.</p></li>
</ul>

<p><a id="x-28HTTP2-2FSERVER-3AGET-NO-CLIENT-POLL-TIMEOUT-20-28MGL-PAX-3AACCESSOR-20HTTP2-2FSERVER-3APOLL-DISPATCHER-MIXIN-29-29"></a>
<a id="HTTP2%2FSERVER:GET-NO-CLIENT-POLL-TIMEOUT%20%28MGL-PAX:ACCESSOR%20HTTP2%2FSERVER:POLL-DISPATCHER-MIXIN%29"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/server/poll-server.lisp#L954">[accessor]</a></span> <span class="reference-object"><a href="#HTTP2%2FSERVER:GET-NO-CLIENT-POLL-TIMEOUT%20%28MGL-PAX:ACCESSOR%20HTTP2%2FSERVER:POLL-DISPATCHER-MIXIN%29" >GET-NO-CLIENT-POLL-TIMEOUT</a></span></span> <span class="locative-args"><a href="#HTTP2%2FSERVER:POLL-DISPATCHER-MIXIN%20CLASS" title="HTTP2/SERVER:POLL-DISPATCHER-MIXIN CLASS">POLL-DISPATCHER-MIXIN</a> (:NO-CLIENT-POLL-TIMEOUT)</span></span></p>

<p>See <a href="#HTTP2%2FSERVER:*NO-CLIENT-POLL-TIMEOUT*%20VARIABLE" title="HTTP2/SERVER:*NO-CLIENT-POLL-TIMEOUT* VARIABLE"><code>*NO-CLIENT-POLL-TIMEOUT*</code></a>.</p></li>
</ul>

<p><a id="x-28HTTP2-2FSERVER-3A-2ANO-CLIENT-POLL-TIMEOUT-2A-20VARIABLE-29"></a>
<a id="HTTP2%2FSERVER:*NO-CLIENT-POLL-TIMEOUT*%20VARIABLE"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/server/poll-server.lisp#L867">[variable]</a></span> <span class="reference-object"><a href="#HTTP2%2FSERVER:*NO-CLIENT-POLL-TIMEOUT*%20VARIABLE" >*NO-CLIENT-POLL-TIMEOUT*</a></span></span> <span class="locative-args">:</span></span></p>

<p>Default timeout in seconds to use when there is no client (to limit time to a client to
connect).</p>

<p>This is supposed to be used primarily in the automated tests, where you do not
want indefinite waits in case of a problem.</p>

<p>On timeout signals <a href="#HTTP2%2FSERVER:POLL-TIMEOUT%20CONDITION" title="HTTP2/SERVER:POLL-TIMEOUT CONDITION"><code>POLL-TIMEOUT</code></a> error.</p>

<p>Default means an indefinite wait.</p></li>
</ul>

<p><a id="x-28HTTP2-2FSERVER-3A-2APOLL-TIMEOUT-2A-20VARIABLE-29"></a>
<a id="HTTP2%2FSERVER:*POLL-TIMEOUT*%20VARIABLE"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/server/poll-server.lisp#L878">[variable]</a></span> <span class="reference-object"><a href="#HTTP2%2FSERVER:*POLL-TIMEOUT*%20VARIABLE" >*POLL-TIMEOUT*</a></span></span> <span class="locative-args">:</span></span></p>

<p>Default timeout in seconds to use for poll when there are connected clients,
but no client communication.</p>

<p>On timeout signals <a href="#HTTP2%2FSERVER:POLL-TIMEOUT%20CONDITION" title="HTTP2/SERVER:POLL-TIMEOUT CONDITION"><code>POLL-TIMEOUT</code></a> error.</p>

<p>Default means an indefinite wait.</p></li>
</ul>

<p><a id="x-28HTTP2-2FSERVER-3APOLL-TIMEOUT-20CONDITION-29"></a>
<a id="HTTP2%2FSERVER:POLL-TIMEOUT%20CONDITION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/server/poll-server.lisp#L861">[condition]</a></span> <span class="reference-object"><a href="#HTTP2%2FSERVER:POLL-TIMEOUT%20CONDITION" >POLL-TIMEOUT</a></span></span> <span class="locative-args">COMMUNICATION-ERROR</span></span></p>

<p>Poll was called with a timeout and returned before any file descriptor became
ready.</p></li>
</ul>

<p><a id="x-28HTTP2-2FSERVER-3ACOMPUTE-POLL-TIMEOUT-VALUE-20FUNCTION-29"></a>
<a id="HTTP2%2FSERVER:COMPUTE-POLL-TIMEOUT-VALUE%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/server/poll-server.lisp#L944">[function]</a></span> <span class="reference-object"><a href="#HTTP2%2FSERVER:COMPUTE-POLL-TIMEOUT-VALUE%20FUNCTION" >COMPUTE-POLL-TIMEOUT-VALUE</a></span></span> <span class="locative-args">HUMAN-FORM</span></span></p>

<p>Compute poll timeout from human readable value (seconds or :) to value accepted by
poll (miliseconds or -1)</p></li>
</ul>

<p><a id="x-28HTTP2-2FSERVER-3A-40REQUEST-HANDLING-20MGL-PAX-3ASECTION-29"></a>
<a id="HTTP2%2FSERVER:@REQUEST-HANDLING%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#HTTP2%2FSERVER:@APP-INTERFACE%20MGL-PAX:SECTION" title="Interface to the polling server">&#8592;</a> <a href="#HTTP2%2FSERVER:@ASYNC-SERVER%20MGL-PAX:SECTION" title="Polling server overview">&#8593;</a> <a href="#HTTP2%2FSERVER:@TLS-ENDPOINT%20MGL-PAX:SECTION" title="`TLS` endpoint">&#8594;</a> <a href="#HTTP2%2FSERVER:@REQUEST-HANDLING%20MGL-PAX:SECTION" title="Client actions loop (implementation)">&#8634;</a> <a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/server/poll-server.lisp#L43">&#955;</a></span></span></p>

<h4><a href="#HTTP2%2FSERVER:@REQUEST-HANDLING%20MGL-PAX:SECTION">4.5.2 Client actions loop (implementation)</a></h4>

<p>Each <a href="#HTTP2%2FSERVER:TLS-ENDPOINT%20STRUCTURE" title="HTTP2/SERVER:TLS-ENDPOINT STRUCTURE"><code>TLS-ENDPOINT</code></a> has a <code>STATE</code> that encapsulates what actions are effectively
possible.</p>

<p><code>SELECT-NEXT-ACTION</code> selects appropriate action. When no new action is available,
next client is handled and eventually <code>POLL</code> called when all clients were served.</p>

<p>The actions are in general indicated by arrows in the diagram:</p>

<p><img src="poll-server.svg" alt="" /></p>

<p><a id="x-28HTTP2-2FSERVER-3A-40TLS-ENDPOINT-20MGL-PAX-3ASECTION-29"></a>
<a id="HTTP2%2FSERVER:@TLS-ENDPOINT%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#HTTP2%2FSERVER:@REQUEST-HANDLING%20MGL-PAX:SECTION" title="Client actions loop (implementation)">&#8592;</a> <a href="#HTTP2%2FSERVER:@REQUEST-HANDLING%20MGL-PAX:SECTION" title="Client actions loop (implementation)">&#8593;</a> <a href="#HTTP2%2FSERVER:@APPLICATION-LOOP%20MGL-PAX:SECTION" title="Application loop">&#8594;</a> <a href="#HTTP2%2FSERVER:@TLS-ENDPOINT%20MGL-PAX:SECTION" title="`TLS` endpoint">&#8634;</a> <a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/server/poll-server.lisp#L37">&#955;</a></span></span></p>

<h5><a href="#HTTP2%2FSERVER:@TLS-ENDPOINT%20MGL-PAX:SECTION"><code>TLS</code> endpoint</a></h5>

<p><a id="x-28HTTP2-2FSERVER-3ATLS-ENDPOINT-20STRUCTURE-29"></a>
<a id="HTTP2%2FSERVER:TLS-ENDPOINT%20STRUCTURE"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/server/poll-server.lisp#L189">[structure]</a></span> <span class="reference-object"><a href="#HTTP2%2FSERVER:TLS-ENDPOINT%20STRUCTURE" >TLS-ENDPOINT</a></span></span> <span class="locative-args">TLS-ENDPOINT-CORE</span></span></p>

<p>Data of one <code>TLS</code> endpoint that is connected to a socket that is part of a <code>FDSET</code>. This includes:</p>

<ul>
<li><p>File descriptor of underlying socket (FD).</p></li>
<li><p>Opaque pointer to the openssl handle (SSL). See <code>SSL-READ</code> and <a href="#HTTP2%2FSERVER:ENCRYPT-SOME%20FUNCTION" title="HTTP2/SERVER:ENCRYPT-SOME FUNCTION"><code>ENCRYPT-SOME</code></a>.</p></li>
<li><p>Input and output BIO for exchanging data with OPENSSL (WBIO, RBIO).</p></li>
<li><p>Buffer of plain text octets to encrypt and send (<code>ENCRYPT-BUF</code>). This buffer reduces <code>TLS</code> records overhead.</p></li>
<li><p>Buffer of encrypted octets to send to the file descriptor (<code>WRITE-BUF</code>). This buffer reduces network headers overhead and removes delays due to Nagle algorithm.</p></li>
<li><p>Callback function when read data are available (<code>IO-ON-READ</code>) and Number of octets required by it (<code>OCTETS-NEEDED</code>). Negative values have special handling. See <a href="#HTTP2%2FSERVER:RUN-USER-CALLBACK%20FUNCTION" title="HTTP2/SERVER:RUN-USER-CALLBACK FUNCTION"><code>RUN-USER-CALLBACK</code></a> for details.</p></li>
<li><p>Client state from the low-level data flow point of view (<code>STATE</code>).</p></li>
<li><p>Application data (slot to be used by the application). This is usually some application structure, but can be also a symbol in tests. Another input to <code>RUN-USER-CALLBACK</code>.</p></li>
</ul></li>
</ul>

<p><a id="x-28HTTP2-2FSERVER-3AMAKE-TLS-ENDPOINT-20FUNCTION-29"></a>
<a id="HTTP2%2FSERVER:MAKE-TLS-ENDPOINT%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/server/poll-server.lisp#L732">[function]</a></span> <span class="reference-object"><a href="#HTTP2%2FSERVER:MAKE-TLS-ENDPOINT%20FUNCTION" >MAKE-TLS-ENDPOINT</a></span></span> <span class="locative-args">SOCKET CTX APPLICATION-DATA IDX</span></span></p>

<p>Make a generic instance of a <a href="#HTTP2%2FSERVER:TLS-ENDPOINT%20STRUCTURE" title="HTTP2/SERVER:TLS-ENDPOINT STRUCTURE"><code>TLS-ENDPOINT</code></a> usable both for a client and for a server.</p>

<p>The read and write buffers are intitialized to new </p></li>
</ul>

<p><a id="x-28HTTP2-2FSERVER-3AWITH-TLS-ENDPOINT-20MGL-PAX-3AMACRO-29"></a>
<a id="HTTP2%2FSERVER:WITH-TLS-ENDPOINT%20MGL-PAX:MACRO"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/server/poll-server.lisp#L750">[macro]</a></span> <span class="reference-object"><a href="#HTTP2%2FSERVER:WITH-TLS-ENDPOINT%20MGL-PAX:MACRO" >WITH-TLS-ENDPOINT</a></span></span> <span class="locative-args">(NAME CONTEXT &amp;KEY (FD -1) APPLICATION-DATA (FDSET-IDX -1)) &amp;BODY BODY</span></span></p>

<p>Run <code>BODY</code> with <code>NAME</code> lexically bound to INIT, and it should be a <code>TLS</code> endpoint.</p>

<p>When control leaves the body, either normally or abnormally, The SSL of the
endpoint is freed.</p>

<p>The defaults reflect the fact that the macro should not be used with <code>TLS</code> endpoints used inside a <code>FDSET</code>.</p></li>
</ul>

<p><a id="x-28HTTP2-2FSERVER-3ADO-AVAILABLE-ACTIONS-20FUNCTION-29"></a>
<a id="HTTP2%2FSERVER:DO-AVAILABLE-ACTIONS%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/server/poll-server.lisp#L558">[function]</a></span> <span class="reference-object"><a href="#HTTP2%2FSERVER:DO-AVAILABLE-ACTIONS%20FUNCTION" >DO-AVAILABLE-ACTIONS</a></span></span> <span class="locative-args">CLIENT</span></span></p>

<p>Run available actions as selected by <code>SELECT-NEXT-ACTION</code> till there is none.</p></li>
</ul>

<p><a id="x-28HTTP2-2FSERVER-3A-40APPLICATION-LOOP-20MGL-PAX-3ASECTION-29"></a>
<a id="HTTP2%2FSERVER:@APPLICATION-LOOP%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#HTTP2%2FSERVER:@TLS-ENDPOINT%20MGL-PAX:SECTION" title="`TLS` endpoint">&#8592;</a> <a href="#HTTP2%2FSERVER:@REQUEST-HANDLING%20MGL-PAX:SECTION" title="Client actions loop (implementation)">&#8593;</a> <a href="#HTTP2%2FSERVER:@PORT-TO-TLS%20MGL-PAX:SECTION" title="Port to `TLS`">&#8594;</a> <a href="#HTTP2%2FSERVER:@APPLICATION-LOOP%20MGL-PAX:SECTION" title="Application loop">&#8634;</a> <a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/server/poll-server.lisp#L63">&#955;</a></span></span></p>

<h5><a href="#HTTP2%2FSERVER:@APPLICATION-LOOP%20MGL-PAX:SECTION">Application loop</a></h5>

<p><a id="x-28HTTP2-2FSERVER-3AON-COMPLETE-SSL-DATA-20FUNCTION-29"></a>
<a id="HTTP2%2FSERVER:ON-COMPLETE-SSL-DATA%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/server/poll-server.lisp#L1016">[function]</a></span> <span class="reference-object"><a href="#HTTP2%2FSERVER:ON-COMPLETE-SSL-DATA%20FUNCTION" >ON-COMPLETE-SSL-DATA</a></span></span> <span class="locative-args">CLIENT</span></span></p>

<p>Read number of octets indicated in <code>CLIENT</code> into a vector and then apply client fn on it.</p>

<p>The code assumes that single client request message is not split across several
<code>TLS</code> frames. If it does, well, connection error.</p></li>
</ul>

<p><a id="x-28HTTP2-2FSERVER-3ARUN-USER-CALLBACK-20FUNCTION-29"></a>
<a id="HTTP2%2FSERVER:RUN-USER-CALLBACK%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/server/poll-server.lisp#L523">[function]</a></span> <span class="reference-object"><a href="#HTTP2%2FSERVER:RUN-USER-CALLBACK%20FUNCTION" >RUN-USER-CALLBACK</a></span></span> <span class="locative-args">CLIENT VEC</span></span></p>

<p>Run user defined callback.</p>

<p>The callback is called with two parameters, client application data (opaque) and vector of <code>OCTETS-NEEDED</code> octets. It should return two values, new callback and new expected size.</p></li>
</ul>

<p><a id="x-28HTTP2-2FSERVER-3AENCRYPT-DATA-20FUNCTION-29"></a>
<a id="HTTP2%2FSERVER:ENCRYPT-DATA%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/server/poll-server.lisp#L436">[function]</a></span> <span class="reference-object"><a href="#HTTP2%2FSERVER:ENCRYPT-DATA%20FUNCTION" >ENCRYPT-DATA</a></span></span> <span class="locative-args">CLIENT</span></span></p>

<p>Encrypt data in client's <code>ENCRYPT-BUF</code>.</p>

<p>Do nothing if there is no data to encrypt or SSL not yet initialized (and return zero).</p>

<p>Otherwise, use a temporary vector to write data </p></li>
</ul>

<p><a id="x-28HTTP2-2FSERVER-3AENCRYPT-SOME-20FUNCTION-29"></a>
<a id="HTTP2%2FSERVER:ENCRYPT-SOME%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/server/poll-server.lisp#L426">[function]</a></span> <span class="reference-object"><a href="#HTTP2%2FSERVER:ENCRYPT-SOME%20FUNCTION" >ENCRYPT-SOME</a></span></span> <span class="locative-args">CLIENT VECTOR FROM TO</span></span></p>

<p>Move octets from <code>VECTOR</code> to the <code>OUTPUT-SSL</code>.</p>

<p>Return 0 when no data are
available. Raise an error on error.</p></li>
</ul>

<p><a id="x-28HTTP2-2FSERVER-3AENCRYPT-AND-SEND-20FUNCTION-29"></a>
<a id="HTTP2%2FSERVER:ENCRYPT-AND-SEND%20FUNCTION"></a></p>

<ul>
<li><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/server/poll-server.lisp#L516">[function]</a></span> <span class="reference-object"><a href="#HTTP2%2FSERVER:ENCRYPT-AND-SEND%20FUNCTION" >ENCRYPT-AND-SEND</a></span></span> <span class="locative-args">CLIENT</span></span></li>
</ul>

<p><a id="x-28HTTP2-2FSERVER-3A-40PORT-TO-TLS-20MGL-PAX-3ASECTION-29"></a>
<a id="HTTP2%2FSERVER:@PORT-TO-TLS%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#HTTP2%2FSERVER:@APPLICATION-LOOP%20MGL-PAX:SECTION" title="Application loop">&#8592;</a> <a href="#HTTP2%2FSERVER:@REQUEST-HANDLING%20MGL-PAX:SECTION" title="Client actions loop (implementation)">&#8593;</a> <a href="#HTTP2%2FSERVER:@TLS-TO-PORT%20MGL-PAX:SECTION" title="`TLS` to port">&#8594;</a> <a href="#HTTP2%2FSERVER:@PORT-TO-TLS%20MGL-PAX:SECTION" title="Port to `TLS`">&#8634;</a> <a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/server/poll-server.lisp#L71">&#955;</a></span></span></p>

<h5><a href="#HTTP2%2FSERVER:@PORT-TO-TLS%20MGL-PAX:SECTION">Port to <code>TLS</code></a></h5>

<p><a id="x-28HTTP2-2FSERVER-3APROCESS-DATA-ON-SOCKET-20FUNCTION-29"></a>
<a id="HTTP2%2FSERVER:PROCESS-DATA-ON-SOCKET%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/server/poll-server.lisp#L338">[function]</a></span> <span class="reference-object"><a href="#HTTP2%2FSERVER:PROCESS-DATA-ON-SOCKET%20FUNCTION" >PROCESS-DATA-ON-SOCKET</a></span></span> <span class="locative-args">CLIENT</span></span></p>

<p>Read data from client socket  and pass them to the tls buffer  to decrypt.</p></li>
</ul>

<p><a id="x-28HTTP2-2FSERVER-3AREAD-FROM-PEER-20FUNCTION-29"></a>
<a id="HTTP2%2FSERVER:READ-FROM-PEER%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/server/poll-server.lisp#L313">[function]</a></span> <span class="reference-object"><a href="#HTTP2%2FSERVER:READ-FROM-PEER%20FUNCTION" >READ-FROM-PEER</a></span></span> <span class="locative-args">CLIENT VEC VEC-SIZE</span></span></p>

<p>Move up to <code>VEC-SIZE</code> octets from <code>PEER-IN</code> to the <code>VEC</code>.</p>

<p>Return 0 when no data are
available. Raise an error on error.</p></li>
</ul>

<p><a id="x-28HTTP2-2FSERVER-3ADECRYPT-SOCKET-OCTETS-20FUNCTION-29"></a>
<a id="HTTP2%2FSERVER:DECRYPT-SOCKET-OCTETS%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/server/poll-server.lisp#L332">[function]</a></span> <span class="reference-object"><a href="#HTTP2%2FSERVER:DECRYPT-SOCKET-OCTETS%20FUNCTION" >DECRYPT-SOCKET-OCTETS</a></span></span> <span class="locative-args">CLIENT VECTOR FROM TO</span></span></p>

<p>Send data in the <code>VECTOR</code> between <code>FROM</code> and <code>TO</code> to the  openssl for decryption .</p></li>
</ul>

<p><a id="x-28HTTP2-2FSERVER-3AWRITE-OCTETS-TO-DECRYPT-20FUNCTION-29"></a>
<a id="HTTP2%2FSERVER:WRITE-OCTETS-TO-DECRYPT%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/server/poll-server.lisp#L324">[function]</a></span> <span class="reference-object"><a href="#HTTP2%2FSERVER:WRITE-OCTETS-TO-DECRYPT%20FUNCTION" >WRITE-OCTETS-TO-DECRYPT</a></span></span> <span class="locative-args">CLIENT VECTOR FROM TO</span></span></p>

<p>Move octets from <code>VECTOR</code> to the <code>OPENSSL-TO-DECRYPT</code>.</p>

<p>Return 0 when no data are
available. Raise an error on error.</p></li>
</ul>

<p><a id="x-28HTTP2-2FSERVER-3A-40TLS-TO-PORT-20MGL-PAX-3ASECTION-29"></a>
<a id="HTTP2%2FSERVER:@TLS-TO-PORT%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#HTTP2%2FSERVER:@PORT-TO-TLS%20MGL-PAX:SECTION" title="Port to `TLS`">&#8592;</a> <a href="#HTTP2%2FSERVER:@REQUEST-HANDLING%20MGL-PAX:SECTION" title="Client actions loop (implementation)">&#8593;</a> <a href="#HTTP2%2FSERVER:@TLS-TO-PORT%20MGL-PAX:SECTION" title="`TLS` to port">&#8634;</a> <a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/server/poll-server.lisp#L77">&#955;</a></span></span></p>

<h5><a href="#HTTP2%2FSERVER:@TLS-TO-PORT%20MGL-PAX:SECTION"><code>TLS</code> to port</a></h5>

<p><a id="x-28HTTP2-2FSERVER-3AMOVE-ENCRYPTED-BYTES-20FUNCTION-29"></a>
<a id="HTTP2%2FSERVER:MOVE-ENCRYPTED-BYTES%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/server/poll-server.lisp#L464">[function]</a></span> <span class="reference-object"><a href="#HTTP2%2FSERVER:MOVE-ENCRYPTED-BYTES%20FUNCTION" >MOVE-ENCRYPTED-BYTES</a></span></span> <span class="locative-args">CLIENT</span></span></p>

<p>Move data encrypted by OpenSSL to the socket write queue .</p>

<p>This should be called in a way friendly to Nagle algorithm. My understaning is
this is either when we pipeline a lot of data, or when we send out somethinf
that expects a response.</p></li>
</ul>

<p><a id="x-28HTTP2-2FSERVER-3AWRITE-DATA-TO-SOCKET-20FUNCTION-29"></a>
<a id="HTTP2%2FSERVER:WRITE-DATA-TO-SOCKET%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type"><a href="https://github.com/zellerin/http2/blob/f3622dd5d435b8027c0535e259c623ada5ecb512/server/poll-server.lisp#L495">[function]</a></span> <span class="reference-object"><a href="#HTTP2%2FSERVER:WRITE-DATA-TO-SOCKET%20FUNCTION" >WRITE-DATA-TO-SOCKET</a></span></span> <span class="locative-args">CLIENT</span></span></p>

<p>Write buffered encrypted data  to the client socket . Update the write buffer to
keep what did not fit.</p></li>
</ul>
  </div>
</div>
<script>$('#page-toc').toc({'selectors': 'h1,h2,h3,h4'});</script>
</body>
</html>
