<!DOCTYPE html>
<html xmlns='http://www.w3.org/1999/xhtml' xml:lang='en' lang='en'>
<head>
<title>HTTP2 in Common Lisp
</title>
<link type='text/css' href='style.css' rel='stylesheet'>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="viewport" content="width=device-width">
   <script src="jquery.min.js"></script>
<script src="toc.min.js"></script>
<script type="text/x-mathjax-config">
     MathJax.Hub.Config({
       tex2jax: {
         inlineMath: [['$','$']],
         processEscapes: true
       }
     });
   </script>
   <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML">
   </script>
   
</head>
<body>
<div id="content-container">
<div id="toc">
<div id="page-toc">
</div>
<div id="toc-footer"><ul><li><a href="https://github.com/melisgl/mgl-pax">[generated by MGL-PAX]</a></li></ul></div>
</div>
<div id="content">
<p><a id="x-28HTTP2-3A-40OVERVIEW-20MGL-PAX-3ASECTION-29"></a>
<a id="HTTP2:@OVERVIEW%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#HTTP2:@FRAMES-API%20MGL-PAX:SECTION" title="Sending and receiving frames">&#8594;</a> <a href="overview.html" title="HTTP2 in Common Lisp">&#8634;</a></span></span></p>

<h1><a href="overview.html">HTTP2 in Common Lisp</a></h1>

<h2>Table of Contents</h2>

<ul>
<li><a href="#HTTP2:@FRAMES-API%20MGL-PAX:SECTION" title="Sending and receiving frames">1 Sending and receiving frames</a></li>
<li><a href="#HTTP2%2FHPACK:@HPACK-API%20MGL-PAX:SECTION" title="HPACK - RFC7541">2 HPACK - RFC7541</a></li>
<li><a href="#HTTP2:@UTILS%20MGL-PAX:SECTION" title="Utilities">3 Utilities</a></li>
<li><a href="#HTTP2:@CALLBACKS%20MGL-PAX:SECTION" title="Frame read callbacks">4 Frame read callbacks</a></li>
<li><a href="#HTTP2:@CLIENT%20MGL-PAX:SECTION" title="Support for creating a client">5 Support for creating a client</a></li>
<li><a href="#HTTP2:@TERMS%20MGL-PAX:SECTION" title="Glossary terms">6 Glossary terms</a></li>
</ul>

<h6>[in package HTTP2]</h6>

<p><a id="x-28HTTP2-3A-40FRAMES-API-20MGL-PAX-3ASECTION-29"></a>
<a id="HTTP2:@FRAMES-API%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="overview.html" title="HTTP2 in Common Lisp">&#8592;</a> <a href="overview.html" title="HTTP2 in Common Lisp">&#8593;</a> <a href="#HTTP2%2FHPACK:@HPACK-API%20MGL-PAX:SECTION" title="HPACK - RFC7541">&#8594;</a> <a href="#HTTP2:@FRAMES-API%20MGL-PAX:SECTION" title="Sending and receiving frames">&#8634;</a></span></span></p>

<h2><a href="#HTTP2:@FRAMES-API%20MGL-PAX:SECTION">1 Sending and receiving frames</a></h2>

<p>Lowest level interace deals with sending and receiving individual frames. For
each frame type there is an anonymous read function called by <a href="#HTTP2:READ-FRAME%20FUNCTION" title="HTTP2:READ-FRAME FUNCTION"><code>READ-FRAME</code></a> based
on the type, and write function (<code>WRITE-DATA-FRAME</code>, ...) The only exception is
continuations frame that are not expected when read-frame is called - they are
processed as part of processing preceding header frame.</p>

<p>The write function are expected to be called individually and each calls
<a href="#HTTP2:WRITE-FRAME-HEADER%20FUNCTION" title="HTTP2:WRITE-FRAME-HEADER FUNCTION"><code>WRITE-FRAME-HEADER</code></a> to send common parts; you should not need to call it, but
it is a good one to trace to debug low level problems. Each write function takes
object identifying the http stream or connection that the frame affects,
additional parameters, and optional parameters that usually relate to the known
flags.</p>

<p><a id="x-28HTTP2-3AREAD-FRAME-20FUNCTION-29"></a>
<a id="HTTP2:READ-FRAME%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[function]</span> <span class="reference-object"><a href="#HTTP2:READ-FRAME%20FUNCTION" >READ-FRAME</a></span></span> <span class="locative-args">CONNECTION &amp;OPTIONAL (STREAM (<code>GET-NETWORK-STREAM</code> <code>CONNECTION</code>))</span></span></p>

<p>Read one frame related to the <code>CONNECTION</code> from <code>STREAM</code>. All frames begin with a
fixed 9-octet header followed by a variable-length payload. The function reads
and processes the header, and then dispatches to a frame type specific
handler that calls appropriate callbacks.</p></li>
</ul>

<p><a id="x-28HTTP2-3AWRITE-FRAME-HEADER-20FUNCTION-29"></a>
<a id="HTTP2:WRITE-FRAME-HEADER%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[function]</span> <span class="reference-object"><a href="#HTTP2:WRITE-FRAME-HEADER%20FUNCTION" >WRITE-FRAME-HEADER</a></span></span> <span class="locative-args">STREAM LENGTH TYPE FLAGS HTTP-STREAM R</span></span></p>

<p>Write a frame header to <code>STREAM</code>.</p></li>
</ul>

<p><a id="x-28HTTP2-3AWRITE-ACK-SETTING-FRAME-20FUNCTION-29"></a>
<a id="HTTP2:WRITE-ACK-SETTING-FRAME%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[function]</span> <span class="reference-object"><a href="#HTTP2:WRITE-ACK-SETTING-FRAME%20FUNCTION" >WRITE-ACK-SETTING-FRAME</a></span></span> <span class="locative-args">CONNECTION</span></span></p>

<p>Write <code>ACK</code> settings frame.</p>

<p><code>ACK</code> (0x1):  When set, bit 0 indicates that this frame acknowledges
   receipt and application of the peer's <code>SETTINGS</code> frame.  When this
   bit is set, the payload of the <code>SETTINGS</code> frame MUST be empty.
   Receipt of a <code>SETTINGS</code> frame with the <code>ACK</code> flag set and a length
   field value other than 0 MUST be treated as a connection error
   (Section 5.4.1) of type FRAME_SIZE_ERROR.  For more information,
   see Section 6.5.3 (&quot;Settings Synchronization&quot;).</p></li>
</ul>

<p><a id="x-28HTTP2-2FHPACK-3A-40HPACK-API-20MGL-PAX-3ASECTION-29"></a>
<a id="HTTP2%2FHPACK:@HPACK-API%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#HTTP2:@FRAMES-API%20MGL-PAX:SECTION" title="Sending and receiving frames">&#8592;</a> <a href="overview.html" title="HTTP2 in Common Lisp">&#8593;</a> <a href="#HTTP2:@UTILS%20MGL-PAX:SECTION" title="Utilities">&#8594;</a> <a href="#HTTP2%2FHPACK:@HPACK-API%20MGL-PAX:SECTION" title="HPACK - RFC7541">&#8634;</a></span></span></p>

<h2><a href="#HTTP2%2FHPACK:@HPACK-API%20MGL-PAX:SECTION">2 HPACK - RFC7541</a></h2>

<h6>[in package HTTP2/HPACK]</h6>

<p>HTTP2 headers can be compressed - and implementation needs to be able to decompress - by two (or maybe three) ways:</p>

<ul>
<li><p>Headers (with or without value) in static headers table (defined in RFC) can be replaced by appropriate a code,</p></li>
<li><p>Headers being sent out may be cached and after first use in dynamic headers table and later replaced by a code,</p></li>
<li><p>Headers as string can be Huffman compressed.</p></li>
</ul>

<p>Dynamic headers table is implemented by <code>HPACK-CONTEXT</code> class that should be
from API point considered opaque. Context is needed twice for each connection,
once for each direction of communication.</p>

<p><a id="x-28HTTP2-2FHPACK-3AREAD-HTTP-HEADER-20FUNCTION-29"></a>
<a id="HTTP2%2FHPACK:READ-HTTP-HEADER%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[function]</span> <span class="reference-object"><a href="#HTTP2%2FHPACK:READ-HTTP-HEADER%20FUNCTION" >READ-HTTP-HEADER</a></span></span> <span class="locative-args">STREAM CONTEXT</span></span></p>

<p>Read one header from network stream using <a href="#HTTP2%2FHPACK:READ-BYTE*%20FUNCTION" title="HTTP2/HPACK:READ-BYTE* FUNCTION"><code>READ-BYTE*</code></a> as two-item list (<code>NAME</code>
<code>VALUE</code>) using dynamic table <code>CONTEXT</code>. Update <code>CONTEXT</code> appropriately.</p>

<p>Can also return <code>NIL</code> if no header is available if it is not detected earlier; this can happen, e.g., when there is a zero sized continuation header frame..</p></li>
</ul>

<p><a id="x-28HTTP2-2FHPACK-3ACOMPILE-HEADERS-20FUNCTION-29"></a>
<a id="HTTP2%2FHPACK:COMPILE-HEADERS%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[function]</span> <span class="reference-object"><a href="#HTTP2%2FHPACK:COMPILE-HEADERS%20FUNCTION" >COMPILE-HEADERS</a></span></span> <span class="locative-args">HEADERS CONTEXT</span></span></p>

<p>Compile headers with given <code>CONTEXT</code> to an array. Context can be <code>NIL</code>; if it is
not, the headers are stored in the dynamic table and the <code>CONTEXT</code> it is updated
appropriately.</p>

<p>Presently returns list of arrays, may return single array in future. In any case, the result should be usable as the appropriate parameter for <code>HTTP2::WRITE-HEADERS-FRAME</code>.</p></li>
</ul>

<p><a id="x-28HTTP2-2FHPACK-3AREQUEST-HEADERS-20FUNCTION-29"></a>
<a id="HTTP2%2FHPACK:REQUEST-HEADERS%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[function]</span> <span class="reference-object"><a href="#HTTP2%2FHPACK:REQUEST-HEADERS%20FUNCTION" >REQUEST-HEADERS</a></span></span> <span class="locative-args">METHOD PATH AUTHORITY &amp;KEY (SCHEME &quot;https&quot;) CONTENT-TYPE GZIP-CONTENT ADDITIONAL-HEADERS</span></span></p>

<p>Encode standard request headers. The obligatory headers are passed as the positional arguments. <code>ADDITIONAL-HEADERS</code> are a list of conses, each containing header name and value.</p></li>
</ul>

<p><a id="x-28HTTP2-2FHPACK-3AUPDATE-DYNAMIC-TABLE-SIZE-20FUNCTION-29"></a>
<a id="HTTP2%2FHPACK:UPDATE-DYNAMIC-TABLE-SIZE%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[function]</span> <span class="reference-object"><a href="#HTTP2%2FHPACK:UPDATE-DYNAMIC-TABLE-SIZE%20FUNCTION" >UPDATE-DYNAMIC-TABLE-SIZE</a></span></span> <span class="locative-args">CONTEXT NEW-SIZE</span></span></p>

<p>Update dynamic table for new size that is smaller than the previous one. This is
called after receiving appropriate settings update.</p>

<p>Zero size means evict completely; in this case the new vector can be cleaned</p></li>
</ul>

<p><a id="x-28HTTP2-2FHPACK-3A-2AUSE-HUFFMAN-CODING-BY-DEFAULT-2A-20VARIABLE-29"></a>
<a id="HTTP2%2FHPACK:*USE-HUFFMAN-CODING-BY-DEFAULT*%20VARIABLE"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[variable]</span> <span class="reference-object"><a href="#HTTP2%2FHPACK:*USE-HUFFMAN-CODING-BY-DEFAULT*%20VARIABLE" >*USE-HUFFMAN-CODING-BY-DEFAULT*</a></span></span> <span class="locative-args">:MAYBE</span></span></p>

<p>Is set, the headers are by default huffman-encoded. Special value :maybe means
whatever is shorter, plain encoding in case of draw.</p></li>
</ul>

<p><a id="x-28HTTP2-2FHPACK-3AHEADER-WRITER-20FUNCTION-29"></a>
<a id="HTTP2%2FHPACK:HEADER-WRITER%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[function]</span> <span class="reference-object"><a href="#HTTP2%2FHPACK:HEADER-WRITER%20FUNCTION" >HEADER-WRITER</a></span></span> <span class="locative-args">RES NAME VALUE &amp;OPTIONAL CONTEXT (HUFFMAN <a href="#HTTP2%2FHPACK:*USE-HUFFMAN-CODING-BY-DEFAULT*%20VARIABLE" title="HTTP2/HPACK:*USE-HUFFMAN-CODING-BY-DEFAULT* VARIABLE"><code>*USE-HUFFMAN-CODING-BY-DEFAULT*</code></a>)</span></span></p>

<p>Encode header consisting of <code>NAME</code> and <code>VALUE</code> to a fillable array <code>RES</code>..</p>

<p>The <code>never-indexed</code> format is never generated, use a separate function for
this (and this function needs to be written).</p>

<p>When <code>CONTEXT</code> is provided, use incremental indexing with dynamic table in
that <code>CONTEXT</code>.</p>

<p>Use Huffman when <code>HUFFMAN</code> is true.</p></li>
</ul>

<p><a id="x-28HTTP2-3A-40UTILS-20MGL-PAX-3ASECTION-29"></a>
<a id="HTTP2:@UTILS%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#HTTP2%2FHPACK:@HPACK-API%20MGL-PAX:SECTION" title="HPACK - RFC7541">&#8592;</a> <a href="overview.html" title="HTTP2 in Common Lisp">&#8593;</a> <a href="#HTTP2:@CALLBACKS%20MGL-PAX:SECTION" title="Frame read callbacks">&#8594;</a> <a href="#HTTP2:@UTILS%20MGL-PAX:SECTION" title="Utilities">&#8634;</a></span></span></p>

<h2><a href="#HTTP2:@UTILS%20MGL-PAX:SECTION">3 Utilities</a></h2>

<p><a id="x-28HTTP2-3AREAD-BYTES-20FUNCTION-29"></a>
<a id="HTTP2:READ-BYTES%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[function]</span> <span class="reference-object"><a href="#HTTP2:READ-BYTES%20FUNCTION" >READ-BYTES</a></span></span> <span class="locative-args">STREAM N</span></span></p>

<p>Read <code>N</code> bytes from stream to an integer</p></li>
</ul>

<p><a id="x-28HTTP2-3AWRITE-BYTES-20FUNCTION-29"></a>
<a id="HTTP2:WRITE-BYTES%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[function]</span> <span class="reference-object"><a href="#HTTP2:WRITE-BYTES%20FUNCTION" >WRITE-BYTES</a></span></span> <span class="locative-args">STREAM N VALUE</span></span></p>

<p>write <code>VALUE</code> as <code>N</code> octets to stream. Maximum length is 64 bits (used by ping).</p></li>
</ul>

<p><a id="x-28HTTP2-2FHPACK-3AREAD-BYTE-2A-20FUNCTION-29"></a>
<a id="HTTP2%2FHPACK:READ-BYTE*%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[function]</span> <span class="reference-object"><a href="#HTTP2%2FHPACK:READ-BYTE*%20FUNCTION" >READ-BYTE*</a></span></span> <span class="locative-args">STREAM</span></span></p>

<p>Read an octet from <code>STREAM</code>, making sure to read additional octets when needed or
applicable.</p>

<p>This is meant to be used for reading header bytes that might be possibly supplemented in an additional continuation frame.</p>

<p>More precisely, the stream that is read from contains known number of octets that can be read, and when they are exhausted, either continuation frame header is read in and count of available octets updated, or <code>MISSING-HEADER-OCTETS</code> condition signalled.</p></li>
</ul>

<p><a id="x-28HTTP2-3AGET-ERROR-NAME-20FUNCTION-29"></a>
<a id="HTTP2:GET-ERROR-NAME%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[function]</span> <span class="reference-object"><a href="#HTTP2:GET-ERROR-NAME%20FUNCTION" >GET-ERROR-NAME</a></span></span> <span class="locative-args">CODE</span></span></p>

<p>Get HTTP/2 error name from the error code.</p></li>
</ul>

<p><a id="x-28HTTP2-3AFIND-SETTING-CODE-20FUNCTION-29"></a>
<a id="HTTP2:FIND-SETTING-CODE%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[function]</span> <span class="reference-object"><a href="#HTTP2:FIND-SETTING-CODE%20FUNCTION" >FIND-SETTING-CODE</a></span></span> <span class="locative-args">NAME</span></span></p>

<p>Find setting name by code</p></li>
</ul>

<p><a id="x-28HTTP2-3AFIND-SETTING-BY-ID-20FUNCTION-29"></a>
<a id="HTTP2:FIND-SETTING-BY-ID%20FUNCTION"></a></p>

<ul>
<li><span class=reference-bullet><span class=reference><span class="locative-type">[function]</span> <span class="reference-object"><a href="#HTTP2:FIND-SETTING-BY-ID%20FUNCTION" >FIND-SETTING-BY-ID</a></span></span> <span class="locative-args">ID</span></span></li>
</ul>

<p><a id="x-28HTTP2-3ASTREAM-ID-20TYPE-29"></a>
<a id="HTTP2:STREAM-ID%20TYPE"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[type]</span> <span class="reference-object"><a href="#HTTP2:STREAM-ID%20TYPE" >STREAM-ID</a></span></span></span></p>

<p>Streams are identified with an unsigned 31-bit  integer.</p></li>
</ul>

<p><a id="x-28HTTP2-3AHTTP2-STREAM-STATE-20TYPE-29"></a>
<a id="HTTP2:HTTP2-STREAM-STATE%20TYPE"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[type]</span> <span class="reference-object"><a href="#HTTP2:HTTP2-STREAM-STATE%20TYPE" >HTTP2-STREAM-STATE</a></span></span></span></p>

<p>HTTP2 state. Currently a symbol from fixed list, might be a number in future.</p></li>
</ul>

<p><a id="x-28HTTP2-3A-40CALLBACKS-20MGL-PAX-3ASECTION-29"></a>
<a id="HTTP2:@CALLBACKS%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#HTTP2:@UTILS%20MGL-PAX:SECTION" title="Utilities">&#8592;</a> <a href="overview.html" title="HTTP2 in Common Lisp">&#8593;</a> <a href="#HTTP2:@CLIENT%20MGL-PAX:SECTION" title="Support for creating a client">&#8594;</a> <a href="#HTTP2:@CALLBACKS%20MGL-PAX:SECTION" title="Frame read callbacks">&#8634;</a></span></span></p>

<h2><a href="#HTTP2:@CALLBACKS%20MGL-PAX:SECTION">4 Frame read callbacks</a></h2>

<p>The reader functions for individual frames may call a callback that is supposed
to handle received frame in some way. All callbacks have stream or connection as
the first parameter.</p>

<p>In addition to the behaviour described below, all callback log the behaviour
when relevant stream or connection has logging-object as superclass.</p>

<p><a id="x-28HTTP2-3AAPPLY-DATA-FRAME-20GENERIC-FUNCTION-29"></a>
<a id="HTTP2:APPLY-DATA-FRAME%20GENERIC-FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[generic-function]</span> <span class="reference-object"><a href="#HTTP2:APPLY-DATA-FRAME%20GENERIC-FUNCTION" >APPLY-DATA-FRAME</a></span></span> <span class="locative-args">STREAM PAYLOAD</span></span></p>

<p>Data frame is received by a stream.
By default does nothing; there are several mixins that implement reading the
data.</p></li>
</ul>

<p><a id="x-28HTTP2-3AAPPLY-STREAM-PRIORITY-20GENERIC-FUNCTION-29"></a>
<a id="HTTP2:APPLY-STREAM-PRIORITY%20GENERIC-FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[generic-function]</span> <span class="reference-object"><a href="#HTTP2:APPLY-STREAM-PRIORITY%20GENERIC-FUNCTION" >APPLY-STREAM-PRIORITY</a></span></span> <span class="locative-args">STREAM EXCLUSIVE WEIGHT STREAM-DEPENDENCY</span></span></p>

<p>Called when priority frame - or other frame with priority settings set -
arrives. Does nothing, as priorities are deprecated in RFC9113 anyway.</p></li>
</ul>

<p><a id="x-28HTTP2-3AAPPLY-WINDOW-SIZE-INCREMENT-20GENERIC-FUNCTION-29"></a>
<a id="HTTP2:APPLY-WINDOW-SIZE-INCREMENT%20GENERIC-FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[generic-function]</span> <span class="reference-object"><a href="#HTTP2:APPLY-WINDOW-SIZE-INCREMENT%20GENERIC-FUNCTION" >APPLY-WINDOW-SIZE-INCREMENT</a></span></span> <span class="locative-args">OBJECT INCREMENT</span></span></p>

<p>Called on window update frame. By default, increases <code>PEER-WINDOW-SIZE</code> slot of
the strem or connection.</p></li>
</ul>

<p><a id="x-28HTTP2-3APEER-RESETS-STREAM-20GENERIC-FUNCTION-29"></a>
<a id="HTTP2:PEER-RESETS-STREAM%20GENERIC-FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[generic-function]</span> <span class="reference-object"><a href="#HTTP2:PEER-RESETS-STREAM%20GENERIC-FUNCTION" >PEER-RESETS-STREAM</a></span></span> <span class="locative-args">STREAM ERROR-CODE</span></span></p>

<p>The RST_STREAM frame fully terminates the referenced stream and
causes it to enter the &quot;closed&quot; state.  After receiving a RST_STREAM
on a stream, the receiver MUST <code>NOT</code>(<a href="http://www.lispworks.com/documentation/HyperSpec/Body/f_not.htm" title="NOT (MGL-PAX:CLHS FUNCTION)"><code>0</code></a> <a href="http://www.lispworks.com/documentation/HyperSpec/Body/t_not.htm" title="NOT (MGL-PAX:CLHS TYPE)"><code>1</code></a>) send additional frames for that
stream, with the exception of <code>PRIORITY</code>.  However, after sending the
RST_STREAM, the sending endpoint MUST be prepared to receive and
process additional frames sent on the stream that might have been
sent by the peer prior to the arrival of the RST_STREAM.</p></li>
</ul>

<p><a id="x-28HTTP2-3ASET-PEER-SETTING-20GENERIC-FUNCTION-29"></a>
<a id="HTTP2:SET-PEER-SETTING%20GENERIC-FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[generic-function]</span> <span class="reference-object"><a href="#HTTP2:SET-PEER-SETTING%20GENERIC-FUNCTION" >SET-PEER-SETTING</a></span></span> <span class="locative-args">CONNECTION NAME VALUE</span></span></p>

<p>Process received information about peers setting.</p>

<p>The setting relates to the <code>CONNECTION</code>. <code>NAME</code> is a keyword symbol (see
<code>*SETTINGS*</code>, subject to possible change to 16bit number in future) and <code>VALUE</code> is
32bit number.</p></li>
</ul>

<p><a id="x-28HTTP2-3APEER-EXPECTS-SETTINGS-ACK-20GENERIC-FUNCTION-29"></a>
<a id="HTTP2:PEER-EXPECTS-SETTINGS-ACK%20GENERIC-FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[generic-function]</span> <span class="reference-object"><a href="#HTTP2:PEER-EXPECTS-SETTINGS-ACK%20GENERIC-FUNCTION" >PEER-EXPECTS-SETTINGS-ACK</a></span></span> <span class="locative-args">CONNECTION</span></span></p>

<p>Called when settings-frame without <code>ACK</code> is received, after individual
<a href="#HTTP2:SET-PEER-SETTING%20GENERIC-FUNCTION" title="HTTP2:SET-PEER-SETTING GENERIC-FUNCTION"><code>SET-PEER-SETTING</code></a> calls. By default, send <code>ACK</code> frame.</p></li>
</ul>

<p><a id="x-28HTTP2-3APEER-ACKS-SETTINGS-20GENERIC-FUNCTION-29"></a>
<a id="HTTP2:PEER-ACKS-SETTINGS%20GENERIC-FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[generic-function]</span> <span class="reference-object"><a href="#HTTP2:PEER-ACKS-SETTINGS%20GENERIC-FUNCTION" >PEER-ACKS-SETTINGS</a></span></span> <span class="locative-args">CONNECTION</span></span></p>

<p>Called when SETTINGS-FRAME with <code>ACK</code> flag is received. By default does nothing.</p></li>
</ul>

<p><a id="x-28HTTP2-3APEER-ENDS-HTTP-STREAM-20GENERIC-FUNCTION-29"></a>
<a id="HTTP2:PEER-ENDS-HTTP-STREAM%20GENERIC-FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[generic-function]</span> <span class="reference-object"><a href="#HTTP2:PEER-ENDS-HTTP-STREAM%20GENERIC-FUNCTION" >PEER-ENDS-HTTP-STREAM</a></span></span> <span class="locative-args">STREAM</span></span></p>

<p>Do relevant state changes when closing http stream (as part of received <code>HEADERS</code> or
<code>PAYLOAD</code>).</p></li>
</ul>

<p><a id="x-28HTTP2-3AHANDLE-UNDEFINED-FRAME-20GENERIC-FUNCTION-29"></a>
<a id="HTTP2:HANDLE-UNDEFINED-FRAME%20GENERIC-FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[generic-function]</span> <span class="reference-object"><a href="#HTTP2:HANDLE-UNDEFINED-FRAME%20GENERIC-FUNCTION" >HANDLE-UNDEFINED-FRAME</a></span></span> <span class="locative-args">TYPE FLAGS LENGTH</span></span></p>

<p>Callback that is called when a frame of unknown type is received - see
extensions.</p></li>
</ul>

<p><a id="x-28HTTP2-3ADO-PONG-20GENERIC-FUNCTION-29"></a>
<a id="HTTP2:DO-PONG%20GENERIC-FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[generic-function]</span> <span class="reference-object"><a href="#HTTP2:DO-PONG%20GENERIC-FUNCTION" >DO-PONG</a></span></span> <span class="locative-args">CONNECTION DATA</span></span></p>

<p>Called when ping-frame with <code>ACK</code> is received. By default warns about unexpected ping response; see also <code>TIMESHIFT-PINGING-CONNECTION</code> mixin.</p></li>
</ul>

<p><a id="x-28HTTP2-3ADO-GOAWAY-20GENERIC-FUNCTION-29"></a>
<a id="HTTP2:DO-GOAWAY%20GENERIC-FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[generic-function]</span> <span class="reference-object"><a href="#HTTP2:DO-GOAWAY%20GENERIC-FUNCTION" >DO-GOAWAY</a></span></span> <span class="locative-args">CONNECTION ERROR-CODE LAST-STREAM-ID DEBUG-DATA</span></span></p>

<p>Called when a go-away frame is received. By default throws <code>GO-AWAY</code> condition if
error was reported.</p></li>
</ul>

<p><a id="x-28HTTP2-3A-40CLIENT-20MGL-PAX-3ASECTION-29"></a>
<a id="HTTP2:@CLIENT%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#HTTP2:@CALLBACKS%20MGL-PAX:SECTION" title="Frame read callbacks">&#8592;</a> <a href="overview.html" title="HTTP2 in Common Lisp">&#8593;</a> <a href="#HTTP2:@TERMS%20MGL-PAX:SECTION" title="Glossary terms">&#8594;</a> <a href="#HTTP2:@CLIENT%20MGL-PAX:SECTION" title="Support for creating a client">&#8634;</a></span></span></p>

<h2><a href="#HTTP2:@CLIENT%20MGL-PAX:SECTION">5 Support for creating a client</a></h2>

<p><a id="x-28HTTP2-3ACONNECT-TO-TLS-SERVER-20FUNCTION-29"></a>
<a id="HTTP2:CONNECT-TO-TLS-SERVER%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[function]</span> <span class="reference-object"><a href="#HTTP2:CONNECT-TO-TLS-SERVER%20FUNCTION" >CONNECT-TO-TLS-SERVER</a></span></span> <span class="locative-args">HOST &amp;KEY (PORT 443) (SNI <code>HOST</code>) VERIFY (ALPN-PROTOCOLS '(&quot;h2&quot;))</span></span></p>

<p>Return a client TLS stream to <code>HOST</code> on <code>PORT</code>, created using <code>SNI</code> and with specified <code>ALPN</code>
protocol (H2 by default).</p></li>
</ul>

<p><a id="x-28HTTP2-3ASEND-HEADERS-20FUNCTION-29"></a>
<a id="HTTP2:SEND-HEADERS%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[function]</span> <span class="reference-object"><a href="#HTTP2:SEND-HEADERS%20FUNCTION" >SEND-HEADERS</a></span></span> <span class="locative-args">STREAM HEADERS &amp;KEY END-STREAM (END-HEADERS <code>T</code>) &amp;ALLOW-OTHER-KEYS</span></span></p>

<p>Send <code>HEADERS</code> to a HTTP2 stream. The stream is returned.</p>

<p>The <code>END-HEADERS</code> and <code>END-STREAM</code> allow to set the appropriate flags.</p></li>
</ul>

<p><a id="x-28HTTP2-3AMAKE-TRANSPORT-OUTPUT-STREAM-20FUNCTION-29"></a>
<a id="HTTP2:MAKE-TRANSPORT-OUTPUT-STREAM%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[function]</span> <span class="reference-object"><a href="#HTTP2:MAKE-TRANSPORT-OUTPUT-STREAM%20FUNCTION" >MAKE-TRANSPORT-OUTPUT-STREAM</a></span></span> <span class="locative-args">HTTP2-STREAM CHARSET GZIP</span></span></p>

<p>An OUTPUT-STREAM built atop RAW <a href="http://www.lispworks.com/documentation/HyperSpec/Body/t_stream.htm" title="STREAM (MGL-PAX:CLHS CLASS)"><code>STREAM</code></a> with transformations based on <code>HEADERS</code>.</p></li>
</ul>

<p><a id="x-28HTTP2-3AMAKE-TRANSPORT-INPUT-STREAM-20FUNCTION-29"></a>
<a id="HTTP2:MAKE-TRANSPORT-INPUT-STREAM%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[function]</span> <span class="reference-object"><a href="#HTTP2:MAKE-TRANSPORT-INPUT-STREAM%20FUNCTION" >MAKE-TRANSPORT-INPUT-STREAM</a></span></span> <span class="locative-args">RAW-STREAM CHARSET GZIP</span></span></p>

<p>INPUT-STREAM built atop <code>RAW-STREAM</code>.</p>

<p>Guess encoding and need to gunzip from headers:
- apply zip decompression if gzip is set
- if charset is not null, use it to convert to text.</p></li>
</ul>

<p><a id="x-28HTTP2-3APROCESS-PENDING-FRAMES-20FUNCTION-29"></a>
<a id="HTTP2:PROCESS-PENDING-FRAMES%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[function]</span> <span class="reference-object"><a href="#HTTP2:PROCESS-PENDING-FRAMES%20FUNCTION" >PROCESS-PENDING-FRAMES</a></span></span> <span class="locative-args">CONNECTION &amp;OPTIONAL JUST-PENDING</span></span></p>

<p>Read and process all queued frames. This is to be called on client when the
initial request was send.</p>

<p>See <code>PROCESS-SERVER-STREAM</code> in dispatch.lisp for a server equivalent that reads
all; note that that one also handles locking in multithread environment and some
other conditions.</p></li>
</ul>

<p><a id="x-28HTTP2-3AHTTP-STREAM-TO-VECTOR-20FUNCTION-29"></a>
<a id="HTTP2:HTTP-STREAM-TO-VECTOR%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[function]</span> <span class="reference-object"><a href="#HTTP2:HTTP-STREAM-TO-VECTOR%20FUNCTION" >HTTP-STREAM-TO-VECTOR</a></span></span> <span class="locative-args">HTTP2-STREAM</span></span></p>

<p>Read HTTP2 raw stream payload data, do guessed conversions and return either
string or octets vector. You can expect the stream to be closed after calling
this.</p></li>
</ul>

<p><a id="x-28HTTP2-3AVANILLA-CLIENT-STREAM-20CLASS-29"></a>
<a id="HTTP2:VANILLA-CLIENT-STREAM%20CLASS"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[class]</span> <span class="reference-object"><a href="#HTTP2:VANILLA-CLIENT-STREAM%20CLASS" >VANILLA-CLIENT-STREAM</a></span></span> <span class="locative-args"><a href="#HTTP2:CLIENT-STREAM%20CLASS" title="HTTP2:CLIENT-STREAM CLASS">CLIENT-STREAM</a> <a href="#HTTP2:HEADER-COLLECTING-MIXIN%20CLASS" title="HTTP2:HEADER-COLLECTING-MIXIN CLASS">HEADER-COLLECTING-MIXIN</a> HISTORY-PRINTING-OBJECT</span></span></p>

<p>Stream class for retrieve-url style functions. Behaves as a client stream,
allows one to treat data frames as streams, collect headers to slot <code>HEADERS</code>
so that they can be later shown as a list, and optionally prints callback
logs. See individual superclasses for details.</p></li>
</ul>

<p><a id="x-28HTTP2-3AVANILLA-CLIENT-CONNECTION-20CLASS-29"></a>
<a id="HTTP2:VANILLA-CLIENT-CONNECTION%20CLASS"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[class]</span> <span class="reference-object"><a href="#HTTP2:VANILLA-CLIENT-CONNECTION%20CLASS" >VANILLA-CLIENT-CONNECTION</a></span></span> <span class="locative-args"><a href="#HTTP2:CLIENT-HTTP2-CONNECTION%20CLASS" title="HTTP2:CLIENT-HTTP2-CONNECTION CLASS">CLIENT-HTTP2-CONNECTION</a> HISTORY-PRINTING-OBJECT TIMESHIFT-PINGING-CONNECTION</span></span></p>

<p>Connection class for retrieve-url style functions that uses streams of
<a href="#HTTP2:VANILLA-CLIENT-STREAM%20CLASS" title="HTTP2:VANILLA-CLIENT-STREAM CLASS"><code>VANILLA-CLIENT-STREAM</code></a>. Behaves as client, can send pings to measure roundtrip
time and optionally prints history. See individual superclasses for details.</p></li>
</ul>

<p><a id="x-28HTTP2-3ACLIENT-STREAM-20CLASS-29"></a>
<a id="HTTP2:CLIENT-STREAM%20CLASS"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[class]</span> <span class="reference-object"><a href="#HTTP2:CLIENT-STREAM%20CLASS" >CLIENT-STREAM</a></span></span></span></p>

<p>HTTP2 stream that checks headers as required for clients (no psedoheader other
than :status allowed, etc.</p></li>
</ul>

<p><a id="x-28HTTP2-3AHEADER-COLLECTING-MIXIN-20CLASS-29"></a>
<a id="HTTP2:HEADER-COLLECTING-MIXIN%20CLASS"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[class]</span> <span class="reference-object"><a href="#HTTP2:HEADER-COLLECTING-MIXIN%20CLASS" >HEADER-COLLECTING-MIXIN</a></span></span></span></p>

<p>Mixin to be used to collect all observed headers to a slot.</p></li>
</ul>

<p><a id="x-28HTTP2-3ACLIENT-HTTP2-CONNECTION-20CLASS-29"></a>
<a id="HTTP2:CLIENT-HTTP2-CONNECTION%20CLASS"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[class]</span> <span class="reference-object"><a href="#HTTP2:CLIENT-HTTP2-CONNECTION%20CLASS" >CLIENT-HTTP2-CONNECTION</a></span></span></span></p>

<p>Client connections have odd-numbered streams.</p></li>
</ul>

<p><a id="x-28HTTP2-3AEXTRACT-CHARSET-FROM-CONTENT-TYPE-20FUNCTION-29"></a>
<a id="HTTP2:EXTRACT-CHARSET-FROM-CONTENT-TYPE%20FUNCTION"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[function]</span> <span class="reference-object"><a href="#HTTP2:EXTRACT-CHARSET-FROM-CONTENT-TYPE%20FUNCTION" >EXTRACT-CHARSET-FROM-CONTENT-TYPE</a></span></span> <span class="locative-args">CONTENT-TYPE</span></span></p>

<p>Guess charset from the content type. <a href="http://www.lispworks.com/documentation/HyperSpec/Body/t_nil.htm" title="NIL (MGL-PAX:CLHS TYPE)"><code>NIL</code></a> for binary data.</p></li>
</ul>

<p><a id="x-28HTTP2-3A-40TERMS-20MGL-PAX-3ASECTION-29"></a>
<a id="HTTP2:@TERMS%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#HTTP2:@CLIENT%20MGL-PAX:SECTION" title="Support for creating a client">&#8592;</a> <a href="overview.html" title="HTTP2 in Common Lisp">&#8593;</a> <a href="#HTTP2:@TERMS%20MGL-PAX:SECTION" title="Glossary terms">&#8634;</a></span></span></p>

<h2><a href="#HTTP2:@TERMS%20MGL-PAX:SECTION">6 Glossary terms</a></h2>

<p><a id="x-28HTTP2-3AHTTP2-CLIENT-20MGL-PAX-3AGLOSSARY-TERM-29"></a>
<a id="HTTP2:HTTP2-CLIENT%20MGL-PAX:GLOSSARY-TERM"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[glossary-term]</span> <span class="reference-object"><a href="#HTTP2:HTTP2-CLIENT%20MGL-PAX:GLOSSARY-TERM" >HTTP/2 client</a></span></span></span></p>

<p>The endpoint that initiates an HTTP/2 connection.  Clients send HTTP
requests and receive HTTP responses.</p></li>
</ul>

<p><a id="x-28HTTP2-3ACONNECTION-TERM-20MGL-PAX-3AGLOSSARY-TERM-29"></a>
<a id="HTTP2:CONNECTION-TERM%20MGL-PAX:GLOSSARY-TERM"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[glossary-term]</span> <span class="reference-object"><a href="#HTTP2:CONNECTION-TERM%20MGL-PAX:GLOSSARY-TERM" >HTTP/2 connection</a></span></span></span></p>

<p>A transport-layer connection between two endpoints.</p></li>
</ul>

<p><a id="x-28HTTP2-3ACONNECTION-ERROR-20MGL-PAX-3AGLOSSARY-TERM-29"></a>
<a id="HTTP2:CONNECTION-ERROR%20MGL-PAX:GLOSSARY-TERM"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[glossary-term]</span> <span class="reference-object"><a href="#HTTP2:CONNECTION-ERROR%20MGL-PAX:GLOSSARY-TERM" >Connection error</a></span></span></span></p>

<p>An error that affects the entire HTTP/2 connection.</p></li>
</ul>

<p><a id="x-28HTTP2-3APEER-20MGL-PAX-3AGLOSSARY-TERM-29"></a>
<a id="HTTP2:PEER%20MGL-PAX:GLOSSARY-TERM"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[glossary-term]</span> <span class="reference-object"><a href="#HTTP2:PEER%20MGL-PAX:GLOSSARY-TERM" >PEER</a></span></span></span></p>

<p>An endpoint.  When discussing a particular endpoint, peer refers to the endpoint that is remote to the primary subject of discussion.</p></li>
</ul>

<p><a id="x-28HTTP2-3ARECEIVER-20MGL-PAX-3AGLOSSARY-TERM-29"></a>
<a id="HTTP2:RECEIVER%20MGL-PAX:GLOSSARY-TERM"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[glossary-term]</span> <span class="reference-object"><a href="#HTTP2:RECEIVER%20MGL-PAX:GLOSSARY-TERM" >RECEIVER</a></span></span></span></p>

<p>An endpoint that is receiving frames.</p></li>
</ul>

<p><a id="x-28HTTP2-3ASENDER-20MGL-PAX-3AGLOSSARY-TERM-29"></a>
<a id="HTTP2:SENDER%20MGL-PAX:GLOSSARY-TERM"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[glossary-term]</span> <span class="reference-object"><a href="#HTTP2:SENDER%20MGL-PAX:GLOSSARY-TERM" >SENDER</a></span></span></span></p>

<p>An endpoint that is transmitting frames.</p></li>
</ul>

<p><a id="x-28HTTP2-3ASERVER-20MGL-PAX-3AGLOSSARY-TERM-29"></a>
<a id="HTTP2:SERVER%20MGL-PAX:GLOSSARY-TERM"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[glossary-term]</span> <span class="reference-object"><a href="#HTTP2:SERVER%20MGL-PAX:GLOSSARY-TERM" >SERVER</a></span></span></span></p>

<p>The endpoint that accepts an HTTP/2 connection.  Servers
receive HTTP requests and send HTTP responses.</p></li>
</ul>

<p><a id="x-28HTTP2-3AHTTP2-STREAM-20MGL-PAX-3AGLOSSARY-TERM-29"></a>
<a id="HTTP2:HTTP2-STREAM%20MGL-PAX:GLOSSARY-TERM"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[glossary-term]</span> <span class="reference-object"><a href="#HTTP2:HTTP2-STREAM%20MGL-PAX:GLOSSARY-TERM" >HTTP2-STREAM</a></span></span></span></p>

<p>A bidirectional flow of frames within the HTTP/2 connection.</p></li>
</ul>

<p><a id="x-28HTTP2-3AHTTP2-STREAM-ERROR-20MGL-PAX-3AGLOSSARY-TERM-29"></a>
<a id="HTTP2:HTTP2-STREAM-ERROR%20MGL-PAX:GLOSSARY-TERM"></a></p>

<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[glossary-term]</span> <span class="reference-object"><a href="#HTTP2:HTTP2-STREAM-ERROR%20MGL-PAX:GLOSSARY-TERM" >HTTP2-STREAM-ERROR</a></span></span></span></p>

<p>An error on the individual HTTP/2 stream.</p></li>
</ul>
  </div>
</div>
<script>$('#page-toc').toc({'selectors': 'h1,h2,h3,h4'});</script>
</body>
</html>
